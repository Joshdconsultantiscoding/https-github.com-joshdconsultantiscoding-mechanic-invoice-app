<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>MechFlow - Professional Mechanic Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;300;400;700;900&family=Plus+Jakarta+Sans:wght@200;400;600;800&display=swap"
        rel="stylesheet">
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#007AFF",
                        "whatsapp": "#25D366",
                        "background-light": "#050505",
                        "background-dark": "#000000",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"],
                        "heading": ["Outfit", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "4px", "lg": "8px", "xl": "12px", "2xl": "16px", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        :root {
            --accent: #007AFF;
            --accent-glow: rgba(0, 122, 255, 0.4);
            --bg-pure: #000000;
            --bg-elevated: #050505;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-pure);
            color: var(--text-primary);
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Outfit', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .fill-1 {
            font-variation-settings: 'FILL' 1;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-[#111418] dark:text-white transition-colors duration-200">
    <div id="root"></div>

    <!-- React and Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/history@5/umd/history.development.js"></script>
    <script src="https://unpkg.com/react-router@6.3.0/umd/react-router.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="store.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { createRoot } = ReactDOM;
        const { MemoryRouter, Routes, Route, Link, useNavigate, useLocation, useParams } = ReactRouterDOM;

        // Data & State Management logic imported from store.js

        // --- Components ---

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught an error", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex items-center justify-center min-h-screen bg-gray-100 text-[#111418] p-4 font-sans">
                            <div className="bg-white p-8 rounded-xl shadow-xl max-w-md w-full border border-gray-200 text-center">
                                <div className="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-red-100 mb-6">
                                    <span className="material-symbols-outlined text-3xl text-red-600">error</span>
                                </div>
                                <h1 className="text-xl font-bold text-gray-900 mb-2">Something went wrong</h1>
                                <p className="text-gray-500 mb-6 text-sm">We realized there was an error. Please try reloading the page to continue.</p>
                                <button
                                    onClick={() => window.location.reload()}
                                    className="w-full bg-primary text-white px-4 py-3 rounded-lg font-bold hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
                                >
                                    <span className="material-symbols-outlined text-sm">refresh</span>
                                    Reload Application
                                </button>
                            </div>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        const PageLoader = () => (
            <div className="fixed inset-0 bg-[#000000] z-[9999] flex flex-col items-center justify-center">
                <div className="relative flex flex-col items-center gap-6">
                    <div style={{ fontFamily: 'Outfit', fontWeight: 900, fontSize: '1.5rem', letterSpacing: '0.2em', color: 'white' }}>
                        MECHFLOW <span style={{ color: '#007AFF' }}>PRO</span>
                    </div>
                    <div className="w-48 h-[1px] bg-white/10 relative overflow-hidden">
                        <div className="absolute inset-0 bg-blue-500 w-1/2 animate-[sidebarLoader_1s_infinite_linear]"></div>
                    </div>
                    <div className="text-[10px] text-white/40 font-bold tracking-[0.3em] uppercase">Loading Terminal</div>
                </div>
                <style>{`
                    @keyframes sidebarLoader {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(200%); }
                    }
                `}</style>
            </div>
        );

        const Layout = ({ children, hideNav, hideHeader }) => {
            const location = useLocation();
            const navigate = useNavigate();
            const activePath = location.pathname;
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const user = Store.getCurrentUser();
            const showBack = activePath !== '/dashboard' && activePath !== '/';
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                setLoading(true);
                const timer = setTimeout(() => setLoading(false), 600); // Simulate loading delay
                return () => clearTimeout(timer);
            }, [location.pathname]);

            // Close sidebar on navigation on mobile
            useEffect(() => {
                setSidebarOpen(false);
            }, [activePath]);

            if (!user) return null; // Or redirect

            return (
                <div className="flex h-screen bg-gray-50 dark:bg-background-dark overflow-hidden">
                    {loading && <PageLoader />}

                    {/* Sidebar Overlay */}
                    {!hideNav && sidebarOpen && (
                        <div
                            className="fixed inset-0 bg-black/50 z-40 lg:hidden backdrop-blur-sm transition-opacity"
                            onClick={() => setSidebarOpen(false)}
                        ></div>
                    )}

                    {/* Sidebar */}
                    {!hideNav && (
                        <aside className={`
                            fixed lg:static inset-y-0 left-0 z-50 w-72 bg-[#111418] dark:bg-gray-900 text-white transform transition-transform duration-300 ease-in-out
                            ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
                            flex flex-col h-full shadow-2xl lg:shadow-none
                        `}>
                            {/* Logo */}
                            <div className="p-6 flex items-center gap-3">
                                <div className="size-10 rounded-xl bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center shadow-lg shadow-primary/30">
                                    <span className="material-symbols-outlined text-white text-xl">build_circle</span>
                                </div>
                                <div>
                                    <h1 className="font-bold text-xl tracking-tight">MechFlow <span className="text-primary">PRO</span></h1>
                                    <p className="text-xs text-gray-400 font-medium tracking-wide">SHOP MANAGER</p>
                                </div>
                            </div>

                            {/* Nav Links */}
                            <div className="flex-1 overflow-y-auto py-6 px-4 space-y-1">
                                <Link to="/dashboard" className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/dashboard' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <span className="material-symbols-outlined">dashboard</span>
                                    Dashboard
                                </Link>
                                <Link to="/create-estimate" className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/create-estimate' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <span className="material-symbols-outlined">add_circle</span>
                                    New Estimate
                                </Link>
                                <Link to="/history" className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/history' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <span className="material-symbols-outlined">history</span>
                                    History
                                </Link>
                                <Link to="/customers" className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/customers' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <span className="material-symbols-outlined">group</span>
                                    Customers
                                </Link>
                                <div className="pt-6 pb-2">
                                    <p className="px-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Settings</p>
                                </div>
                                <Link to="/profile" className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/profile' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <span className="material-symbols-outlined">person</span>
                                    Profile
                                </Link>
                                <Link to="/settings" className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/settings' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <span className="material-symbols-outlined">settings</span>
                                    Settings
                                </Link>
                            </div>

                            {/* User Profile */}
                            <div className="p-4 border-t border-white/10 mx-4 mb-4">
                                <div className="flex items-center gap-3 p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-colors cursor-pointer group">
                                    <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80" className="size-10 rounded-full border-2 border-primary/50" />
                                    <div className="flex-1 min-w-0">
                                        <p className="text-sm font-bold text-white truncate">John Mechanic</p>
                                        <p className="text-xs text-gray-400 truncate group-hover:text-primary transition-colors">View Profile</p>
                                    </div>
                                    <button onClick={Store.logout} className="text-gray-400 hover:text-red-400 transition-colors">
                                        <span className="material-symbols-outlined text-xl">logout</span>
                                    </button>
                                </div>
                            </div>
                        </aside>
                    )}

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col h-full relative">
                        {/* Header */}
                        {!hideHeader && (
                            <header className="bg-white dark:bg-gray-900 h-20 px-8 flex items-center justify-between border-b border-gray-100 dark:border-gray-800 shrink-0">
                                <div className="flex items-center gap-4">
                                    {!hideNav && (
                                        <button onClick={() => setSidebarOpen(true)} className="lg:hidden p-2 -ml-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400">
                                            <span className="material-symbols-outlined">menu</span>
                                        </button>
                                    )}
                                    {showBack && (
                                        <button onClick={() => navigate(-1)} className="p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400 transition-colors">
                                            <span className="material-symbols-outlined">arrow_back</span>
                                        </button>
                                    )}
                                    <h2 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-400">
                                        {activePath === '/dashboard' ? `Good Morning, ${user.name.split(' ')[0]}` :
                                            activePath.replace('/', '').split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
                                    </h2>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => navigate('/notifications')} className="size-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center text-gray-600 dark:text-gray-400 relative transition-colors">
                                        <span className="material-symbols-outlined">notifications</span>
                                        <span className="absolute top-2 right-2 size-2 bg-red-500 rounded-full border-2 border-white dark:border-gray-900"></span>
                                    </button>
                                    <div className="h-8 w-px bg-gray-200 dark:bg-gray-800 mx-2"></div>
                                    <div className="flex flex-col items-end">
                                        <span className="text-xs font-bold text-gray-400 uppercase tracking-widest">Shop Status</span>
                                        <span className="text-sm font-bold text-green-500 flex items-center gap-1">
                                            <span className="size-2 bg-green-500 rounded-full animate-pulse"></span>
                                            Open
                                        </span>
                                    </div>
                                </div>
                            </header>
                        )}

                        {/* Scrollable Area */}
                        <div className="flex-1 overflow-y-auto overflow-x-hidden p-4 pb-24 lg:pb-4 relative scroll-smooth">
                            {children}
                        </div>

                        {/* Mobile Bottom Nav */}
                        {!hideNav && (
                            <nav className="lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 px-6 py-3 flex justify-between items-center z-40 pb-safe">
                                <Link to="/dashboard" className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors ${activePath === '/dashboard' ? 'text-primary' : 'text-gray-400'}`}>
                                    <span className={`material-symbols-outlined ${activePath === '/dashboard' ? 'fill-1' : ''}`}>dashboard</span>
                                    <span className="text-[10px] font-bold">Home</span>
                                </Link>
                                <Link to="/customers" className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors ${activePath === '/customers' ? 'text-primary' : 'text-gray-400'}`}>
                                    <span className={`material-symbols-outlined ${activePath === '/customers' ? 'fill-1' : ''}`}>person</span>
                                    <span className="text-[10px] font-bold">Clients</span>
                                </Link>
                                <Link to="/create-estimate" className="flex flex-col items-center gap-1 -mt-8">
                                    <div className="size-14 bg-primary text-white rounded-full shadow-xl shadow-primary/30 flex items-center justify-center transform active:scale-95 transition-transform">
                                        <span className="material-symbols-outlined text-2xl">add</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-primary mt-1">Estimate</span>
                                </Link>
                                <Link to="/history" className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors ${activePath === '/history' ? 'text-primary' : 'text-gray-400'}`}>
                                    <span className={`material-symbols-outlined ${activePath === '/history' ? 'fill-1' : ''}`}>history</span>
                                    <span className="text-[10px] font-bold">History</span>
                                </Link>
                                <Link to="/settings" className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors ${activePath === '/settings' ? 'text-primary' : 'text-gray-400'}`}>
                                    <span className={`material-symbols-outlined ${activePath === '/settings' ? 'fill-1' : ''}`}>settings</span>
                                    <span className="text-[10px] font-bold">Settings</span>
                                </Link>
                            </nav>
                        )}
                    </div>
                </div>
            );
        };

        const StatusBadge = ({ status }) => {
            const config = {
                pending: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 border-l-4 border-l-amber-500",
                approved: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 border-l-4 border-l-emerald-500",
                sent: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 border-l-4 border-l-blue-500",
                archived: "bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400 border-l-4 border-l-gray-500 line-through opacity-70",
                deleted: "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 border-l-4 border-l-red-500" // Fallback if name varies
            };
            const label = { pending: "Pending", approved: "Approved", sent: "Sent", archived: "Archived", deleted: "Deleted" };
            return (
                <span className={`${config[status] || config.pending} text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider`}>
                    {label[status] || status}
                </span>
            );
        };

        const LoginScreen = () => {
            const navigate = useNavigate();
            const [loadingExternal, setLoadingExternal] = useState(false);
            const [currentImg, setCurrentImg] = useState(0);

            const images = [
                'https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?q=80&w=2672&auto=format&fit=crop',
                'https://images.unsplash.com/photo-1530046339160-ce3e5b0c7a2f?q=80&w=2670&auto=format&fit=crop',
                'https://images.unsplash.com/photo-1503376780353-7e6692767b70?q=80&w=2670&auto=format&fit=crop'
            ];

            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentImg((prev) => (prev + 1) % images.length);
                }, 6000);
                return () => clearInterval(timer);
            }, []);

            const handleCustomerPortal = (e) => {
                e.preventDefault();
                setLoadingExternal(true);
                setTimeout(() => {
                    window.location.href = "customer.html";
                }, 1200);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const email = formData.get('email');
                const password = formData.get('password');

                const user = Store.login(email, password);

                if (user) {
                    if (user.role === 'mechanic') {
                        navigate('/dashboard');
                    } else {
                        alert("Customer login detected. Please use the Customer Portal.");
                    }
                } else {
                    alert("Invalid login.");
                }
            };

            return (
                <div className="flex min-h-screen bg-gray-50 dark:bg-background-dark">
                    {loadingExternal && <PageLoader />}

                    {/* Mobile Branding (Only visible on small screens) */}
                    <div className="lg:hidden absolute top-0 left-0 right-0 p-6 z-50 flex justify-between items-center bg-gradient-to-b from-gray-900/60 to-transparent">
                        <div className="flex items-center gap-2">
                            <div className="size-8 rounded-lg bg-primary flex items-center justify-center">
                                <span className="material-symbols-outlined text-white text-lg">build_circle</span>
                            </div>
                            <span className="font-bold text-white tracking-tight">MechFlow PRO</span>
                        </div>
                        <button
                            onClick={handleCustomerPortal}
                            className="bg-white/10 backdrop-blur-md text-white text-xs font-bold px-3 py-1.5 rounded-full border border-white/20"
                        >
                            Customer Portal
                        </button>
                    </div>

                    {/* Left Side - Hero Slider */}
                    <div className="hidden lg:flex w-1/2 relative overflow-hidden bg-gray-900">
                        {images.map((img, idx) => (
                            <div
                                key={idx}
                                className={`absolute inset-0 transition-opacity duration-[2000ms] ${idx === currentImg ? 'opacity-100 scale-100' : 'opacity-0 scale-110'}`}
                                style={{
                                    backgroundImage: `url(${img})`,
                                    backgroundSize: 'cover',
                                    backgroundPosition: 'center',
                                    transitionProperty: 'opacity, transform'
                                }}
                            ></div>
                        ))}
                        <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-black/30 z-10"></div>
                        <div className="absolute inset-0 bg-primary/10 mix-blend-overlay z-10"></div>

                        <div className="relative z-20 mt-auto p-16 text-white max-w-xl">
                            <div className="size-16 rounded-2xl bg-primary flex items-center justify-center mb-8 shadow-2xl shadow-primary/20">
                                <span className="material-symbols-outlined text-3xl">construction</span>
                            </div>
                            <h1 className="text-6xl font-black mb-6 leading-tight tracking-tighter">Tools of the<br />Future.</h1>
                            <p className="text-xl text-gray-300 font-medium leading-relaxed opacity-80">
                                Management built for precision. Track every job, part, and customer with MechFlow PRO.
                            </p>
                        </div>
                    </div>

                    {/* Right Side - Form */}
                    <div className="w-full lg:w-1/2 flex flex-col justify-center items-center px-6 lg:px-20 relative bg-white dark:bg-gray-900">
                        {/* Desktop Customer Link */}
                        <div className="hidden lg:block absolute top-10 right-10">
                            <button
                                onClick={handleCustomerPortal}
                                className="flex items-center gap-2 text-sm font-bold text-gray-500 hover:text-primary transition-all bg-gray-50 dark:bg-gray-800 px-5 py-2.5 rounded-xl border border-gray-100 dark:border-gray-700"
                            >
                                <span className="material-symbols-outlined text-lg">local_taxi</span>
                                Customer Portal
                            </button>
                        </div>

                        <div className="max-w-[420px] w-full animate-[fadeIn_0.5s_ease-out]">
                            <div className="mb-12 text-center lg:text-left">
                                <div className="lg:hidden size-20 bg-primary/10 rounded-[2rem] flex items-center justify-center mx-auto mb-8 animate-pulse">
                                    <span className="material-symbols-outlined text-4xl text-primary">engineering</span>
                                </div>
                                <h1 className="text-4xl lg:text-5xl font-black text-gray-900 dark:text-white mb-4 tracking-tight">
                                    Welcome, Mike.
                                </h1>
                                <p className="text-gray-500 dark:text-gray-400 text-lg font-medium leading-relaxed">
                                    Sign in to your shop floor.
                                </p>
                            </div>

                            <form className="flex flex-col gap-6" onSubmit={handleSubmit}>
                                <div className="space-y-2">
                                    <label className="text-xs font-black uppercase tracking-widest text-gray-400 pl-1">Work Email</label>
                                    <div className="relative group">
                                        <span className="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-300 group-focus-within:text-primary transition-colors">alternate_email</span>
                                        <input
                                            name="email"
                                            className="w-full h-16 pl-12 pr-4 rounded-[1.25rem] border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50 text-gray-900 dark:text-white focus:ring-4 focus:ring-primary/5 focus:border-primary transition-all font-bold"
                                            defaultValue="mechanic@example.com"
                                            type="email"
                                            required
                                        />
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-xs font-black uppercase tracking-widest text-gray-400 pl-1">Secure Password</label>
                                    <div className="relative group">
                                        <span className="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-300 group-focus-within:text-primary transition-colors">verified_user</span>
                                        <input
                                            name="password"
                                            className="w-full h-16 pl-12 pr-4 rounded-[1.25rem] border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50 text-gray-900 dark:text-white focus:ring-4 focus:ring-primary/5 focus:border-primary transition-all font-bold"
                                            defaultValue="password"
                                            type="password"
                                            required
                                        />
                                    </div>
                                </div>

                                <button className="w-full h-16 mt-6 bg-gray-900 dark:bg-primary hover:bg-black dark:hover:bg-primary/90 text-white rounded-[1.25rem] font-black text-lg shadow-2xl shadow-gray-200 dark:shadow-primary/30 transition-all hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-3">
                                    Enter Workshop
                                    <span className="material-symbols-outlined">login</span>
                                </button>
                            </form>

                            <div className="mt-10 pt-10 border-t border-gray-50 dark:border-gray-800 text-center">
                                <p className="text-xs text-gray-400 font-bold uppercase tracking-widest">Authorized Personnel Only</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };




        const DashboardScreen = () => {
            const navigate = useNavigate();
            const [estimates, setEstimates] = useState([]);

            useEffect(() => {
                setEstimates(Store.getEstimates().filter(e => e.status !== 'archived'));
            }, []);

            return (
                <Layout>
                    <main className="flex justify-center py-6 px-4 pb-28">
                        <div className="w-full max-w-[600px] flex flex-col gap-6">
                            <div className="flex flex-col gap-1">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-2xl font-bold tracking-tight">Active Estimates</h2>
                                    <span className="bg-primary/10 text-primary text-xs font-bold px-2 py-1 rounded-full">{estimates.length} Total</span>
                                </div>
                                <p className="text-[#617589] text-sm">Review and send these quotes to your customers.</p>
                            </div>

                            {estimates.length === 0 ? (
                                <div className="text-center py-10 bg-white dark:bg-gray-900 rounded-xl border border-dashed border-gray-300 dark:border-gray-700">
                                    <p className="text-gray-500">No active estimates.</p>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-4">
                                    {estimates.map(est => (
                                        <div key={est.id}
                                            onClick={() => navigate(`/review/${est.id}`)}
                                            className={`cursor-pointer bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-[#f0f2f4] dark:border-gray-800 overflow-hidden flex flex-col sm:flex-row transition-all hover:shadow-md hover:scale-[1.01] border-l-4 ${est.status === 'pending' ? 'border-l-amber-500' : est.status === 'approved' ? 'border-l-emerald-500' : 'border-l-blue-500'}`}>
                                            <div className="w-full sm:w-32 h-32 sm:h-auto bg-cover bg-center shrink-0" style={{ backgroundImage: `url(${est.img})` }}></div>
                                            <div className="flex-1 p-4 flex flex-col gap-3">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <StatusBadge status={est.status} />
                                                            <span className="text-[10px] font-medium text-[#617589]">{est.date}</span>
                                                        </div>
                                                        <h3 className="text-lg font-bold text-primary">{est.customer}</h3>
                                                    </div>
                                                    <span className="bg-[#f0f2f4] dark:bg-gray-800 text-xs font-medium px-2 py-1 rounded">{est.id}</span>
                                                </div>
                                                <div className="flex flex-col gap-1">
                                                    <div className="flex items-center gap-2 text-sm text-[#111418] dark:text-gray-300">
                                                        <span className="material-symbols-outlined text-base">directions_car</span>
                                                        <span>{est.vehicle}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-[#617589]">
                                                        <span className="material-symbols-outlined text-base">build</span>
                                                        <span>{est.service}</span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-between pt-2 border-t border-[#f0f2f4] dark:border-gray-800">
                                                    <p className="text-lg font-bold">${Number(est.amount).toFixed(2)}</p>
                                                    <button
                                                        className="bg-primary text-white text-sm font-semibold px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors active:scale-95">
                                                        {est.status === 'pending' ? 'Review & Price' : est.status === 'approved' ? 'View/Send' : 'View Invoice'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            <button onClick={() => navigate('/create-estimate')} className="flex items-center justify-center gap-2 w-full py-4 border-2 border-dashed border-primary/30 rounded-xl text-primary font-bold hover:bg-primary/5 transition-colors">
                                <span className="material-symbols-outlined">add_circle</span>
                                <span>Create New Estimate (Manual)</span>
                            </button>
                        </div>
                    </main>
                </Layout>
            );
        };

        const CreateEstimateScreen = () => {
            const navigate = useNavigate();

            const handleSubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const newEst = Store.createEstimate({
                    customer: formData.get('customer'),
                    phone: formData.get('phone'),
                    vehicle: formData.get('vehicle'),
                    service: formData.get('service'),
                    customerKey: formData.get('customerKey') ? formData.get('customerKey').trim().toUpperCase() : null,
                    notes: 'Created manually by mechanic'
                });
                navigate('/review/' + newEst.id);
            };

            return (
                <Layout>
                    <div className="flex justify-center py-6 px-4 pb-20">
                        <div className="w-full max-w-[600px] flex flex-col gap-6">
                            <div className="flex flex-col gap-2 mb-4">
                                <Link to="/dashboard" className="flex items-center gap-2 text-primary mb-2 text-sm font-semibold uppercase tracking-wider">
                                    <span className="material-symbols-outlined text-sm">arrow_back</span> Back to Dashboard
                                </Link>
                                <h1 className="text-3xl font-black tracking-tight">Create Estimate</h1>
                                <p className="text-[#617589] dark:text-gray-400">Fill in the details to start a new estimate for a client.</p>
                            </div>

                            <form className="flex flex-col gap-6 bg-white dark:bg-gray-900 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800" onSubmit={handleSubmit}>

                                <div className="p-4 bg-primary/5 rounded-xl border border-primary/10">
                                    <div className="flex flex-col gap-2">
                                        <label className="font-semibold dark:text-gray-200 text-sm flex items-center gap-2">
                                            <span className="material-symbols-outlined text-primary">link</span>
                                            Customer Link Key (Optional)
                                        </label>
                                        <div className="flex gap-2">
                                            <input name="customerKey" className="form-input flex-1 rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-12 px-4 font-mono text-sm uppercase tracking-wider" placeholder="e.g. C-XXXX" />
                                        </div>
                                        <p className="text-xs text-gray-500">Enter the customer's unique key (found on their dashboard) to link this estimate directly.</p>
                                    </div>
                                </div>

                                <div className="flex flex-col gap-2">
                                    <label className="font-semibold dark:text-gray-200">Full Name</label>
                                    <input name="customer" className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-14 px-4" placeholder="Client Name" required />
                                </div>
                                <div className="flex flex-col gap-2">
                                    <label className="font-semibold dark:text-gray-200">Phone Number</label>
                                    <input name="phone" className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-14 px-4" placeholder="(555) 000-0000" type="tel" required />
                                </div>
                                <div className="flex flex-col gap-2">
                                    <label className="font-semibold dark:text-gray-200">Vehicle Details</label>
                                    <input name="vehicle" className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-14 px-4" placeholder="e.g. 2018 Toyota Camry" required />
                                </div>
                                <div className="flex flex-col gap-2">
                                    <label className="font-semibold dark:text-gray-200">Service Needed</label>
                                    <select name="service" className="form-select rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-14 px-4" required>
                                        <option value="">Select a service</option>
                                        <option value="Oil Change">Oil Change</option>
                                        <option value="Brake Repair">Brake Repair</option>
                                        <option value="Engine Diagnostic">Engine Diagnostic</option>
                                        <option value="General Repair">General Repair</option>
                                    </select>
                                </div>
                                <button className="w-full bg-primary hover:bg-primary/90 text-white font-bold text-lg py-5 rounded-xl shadow-lg mt-4 transition-all" type="submit">
                                    Continue to Costing
                                </button>
                            </form>
                        </div>
                    </div>
                </Layout>
            );
        };

        const ReviewScreen = () => {
            const navigate = useNavigate();
            const { id } = useParams();
            const [estimate, setEstimate] = useState(null);

            // Editable fields
            const [labor, setLabor] = useState(0);
            const [parts, setParts] = useState(0);
            const [taxRate, setTaxRate] = useState(8.25);

            useEffect(() => {
                const est = Store.getEstimate(id);
                if (!est) return navigate('/dashboard');
                setEstimate(est);
                setLabor(est.laborCost);
                setParts(est.partsCost);
            }, [id]);

            const subtotal = useMemo(() => Number(labor) + Number(parts), [labor, parts]);
            const taxAmount = useMemo(() => (subtotal * taxRate) / 100, [subtotal, taxRate]);
            const total = useMemo(() => subtotal + taxAmount, [subtotal, taxAmount]);

            const handleSave = (status) => {
                const updated = Object.assign({}, estimate, {
                    laborCost: Number(labor),
                    partsCost: Number(parts),
                    tax: taxAmount,
                    amount: total,
                    status: status
                });
                Store.saveEstimate(updated);
                setEstimate(updated);

                if (status === 'approved') {
                    navigate('/processing/' + id);
                } else {
                    alert('Draft Saved');
                }
            };

            const handleDelete = () => {
                if (window.confirm('Are you sure you want to archive this request? It will be moved to history as deleted.')) {
                    Store.deleteEstimate(id);
                    navigate('/dashboard');
                }
            };

            if (!estimate) return <Layout><div className="text-center p-10">Loading...</div></Layout>;

            return (
                <Layout>
                    <div className="flex flex-1 justify-center py-8 px-4 md:px-0 mb-20 animate-[fadeIn_0.3s_ease-out]">
                        <div className="flex flex-col max-w-[800px] flex-1">
                            <div className="flex flex-wrap gap-2 pb-4">
                                <Link className="text-[#617589] text-sm font-medium hover:underline flex items-center gap-1" to="/dashboard">
                                    <span className="material-symbols-outlined text-sm">arrow_back</span>Estimates
                                </Link>
                                <span className="text-[#617589] text-sm font-medium">/</span>
                                <span className="text-[#111418] dark:text-gray-400 text-sm font-medium">{estimate.id}</span>
                            </div>
                            <div className="flex flex-wrap justify-between items-end gap-3 pb-6">
                                <div className="flex min-w-72 flex-col gap-1">
                                    <h1 className="text-3xl font-black tracking-tight">{estimate.status === 'pending' ? 'Review & Costing' : 'Estimate Details'}</h1>
                                    <p className="text-[#617589] dark:text-gray-400 text-base">Finalize the numbers and approve for sending to client</p>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={handleDelete} className="flex min-w-[40px] items-center justify-center rounded-lg h-10 px-3 bg-red-50 text-red-500 hover:bg-red-100 transition-colors" title="Archive Request">
                                        <span className="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                    <button onClick={() => handleSave('pending')} className="flex min-w-[100px] items-center justify-center rounded-lg h-10 px-4 bg-gray-100 dark:bg-gray-800 text-[#111418] dark:text-white text-sm font-bold hover:bg-gray-200 transition-colors">
                                        <span>Save Draft</span>
                                    </button>
                                </div>
                            </div>

                            <div className="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-4 mb-6 shadow-sm">
                                <div className="flex flex-col md:flex-row gap-6">
                                    <div className="w-full md:w-48 bg-center bg-no-repeat aspect-video bg-cover rounded-lg border border-gray-100 dark:border-gray-700" style={{ backgroundImage: `url(${estimate.img})` }}></div>
                                    <div className="flex flex-1 flex-col justify-center gap-1">
                                        <div className="flex items-center gap-2">
                                            <span className="material-symbols-outlined text-gray-400 text-xl">person</span>
                                            <p className="text-lg font-bold">{estimate.customer}</p>
                                        </div>
                                        <div className="flex items-center gap-2 text-primary font-medium text-sm">
                                            <span className="material-symbols-outlined text-sm">call</span>
                                            <p>{estimate.phone}</p>
                                        </div>
                                        <div className="flex flex-wrap gap-x-4 gap-y-1 mt-2">
                                            <div className="flex items-center gap-1">
                                                <span className="material-symbols-outlined text-gray-400 text-sm">directions_car</span>
                                                <p className="text-[#617589] dark:text-gray-400 text-sm">{estimate.vehicle}</p>
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <span className="material-symbols-outlined text-gray-400 text-sm">assignment</span>
                                                <p className="text-[#617589] dark:text-gray-400 text-sm">{estimate.service}</p>
                                            </div>
                                        </div>
                                        {estimate.notes && (
                                            <div className="mt-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg text-sm text-gray-600 dark:text-gray-300 italic border-l-2 border-primary">
                                                "{estimate.notes}"
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden shadow-sm">
                                <h2 className="text-[20px] font-bold px-6 py-5 border-b border-gray-100 dark:border-gray-800">Costing Details</h2>
                                <div className="p-6 space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="flex flex-col gap-2">
                                            <label className="text-sm font-bold">Labor Cost</label>
                                            <div className="relative">
                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
                                                <input
                                                    className="w-full rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-800 pl-8 pr-4 py-2 focus:ring-primary focus:border-primary"
                                                    value={labor}
                                                    onChange={(e) => setLabor(e.target.value)}
                                                    type="number"
                                                />
                                            </div>
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <label className="text-sm font-bold">Parts Cost</label>
                                            <div className="relative">
                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
                                                <input
                                                    className="w-full rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-800 pl-8 pr-4 py-2 focus:ring-primary focus:border-primary"
                                                    value={parts}
                                                    onChange={(e) => setParts(e.target.value)}
                                                    type="number"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-primary/5 dark:bg-primary/10 rounded-xl p-6 border border-primary/20">
                                        <div className="space-y-3">
                                            <div className="flex justify-between text-sm">
                                                <span className="text-[#617589]">Subtotal</span>
                                                <span className="font-medium">${Number(subtotal).toFixed(2)}</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-[#617589]">Tax (8.25%)</span>
                                                <span className="font-medium">${Number(taxAmount).toFixed(2)}</span>
                                            </div>
                                            <div className="pt-3 border-t border-primary/20 flex justify-between items-center">
                                                <span className="text-lg font-bold">Grand Total</span>
                                                <span className="text-primary text-2xl font-black">${Number(total).toFixed(2)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => handleSave('approved')}
                                        className="w-full h-12 flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-white rounded-lg font-bold transition-all shadow-md active:scale-95">
                                        <span className="material-symbols-outlined">send</span> {estimate.status === 'sent' ? 'Resend Invoice' : 'Confirm & Send'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </Layout>
            );
        };



        const InvoiceScreen = () => {
            const navigate = useNavigate();
            const { id } = useParams();
            const estimate = Store.getEstimate(id);

            if (!estimate) return <div className="p-10 text-center">Estimate Not Found</div>;

            const handleMarkPaid = () => {
                Store.markPaid(id);
                navigate('/success');
            };

            const handleWhatsapp = () => {
                const text = `Hello ${estimate.customer}, your invoice #${estimate.id} for ${estimate.service} is ready. Total: $${Number(estimate.amount).toFixed(2)}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                const updated = Object.assign({}, estimate, { status: 'sent' });
                Store.saveEstimate(updated);
            };

            return (
                <Layout>
                    <header className="no-print sticky top-0 z-50 w-full bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 py-3">
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            <button onClick={() => navigate('/dashboard')} className="flex items-center gap-2 text-slate-600 dark:text-slate-400 hover:text-primary">
                                <span className="material-symbols-outlined">arrow_back</span>
                                <span className="text-sm font-medium">Back</span>
                            </button>
                            <div className="flex items-center gap-2 md:gap-3">
                                <button className="flex items-center gap-2 px-4 py-2 text-sm font-semibold border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800" onClick={() => window.print()}>
                                    <span className="material-symbols-outlined text-lg">print</span><span className="hidden sm:inline">Print</span>
                                </button>
                                <button onClick={handleWhatsapp} className="flex items-center gap-2 px-4 py-2 text-sm font-semibold bg-whatsapp text-white rounded-lg hover:opacity-90">
                                    <span className="material-symbols-outlined text-lg">share</span><span>WhatsApp</span>
                                </button>
                                <button className="flex items-center gap-2 px-4 py-2 text-sm font-semibold bg-primary text-white rounded-lg hover:bg-primary/90" onClick={handleMarkPaid}>
                                    <span className="material-symbols-outlined text-lg">check_circle</span><span className="hidden sm:inline">Mark Paid</span>
                                </button>
                            </div>
                        </div>
                    </header>
                    <div className="flex flex-col items-center py-8 px-4 print-m-0 pb-32">
                        <div className="w-full max-w-4xl bg-white dark:bg-slate-900 rounded-xl shadow-xl border border-slate-200 dark:border-slate-800 overflow-hidden print-shadow-none print-border">
                            <div className="p-8 md:p-12 border-b border-slate-100 dark:border-slate-800">
                                <div className="flex flex-col md:flex-row justify-between gap-8">
                                    <div>
                                        <div className="flex items-center gap-3 mb-4">
                                            <div className="size-10 bg-primary rounded-lg flex items-center justify-center text-white">
                                                <span className="material-symbols-outlined text-2xl">build</span>
                                            </div>
                                            <h1 className="text-xl font-black uppercase tracking-tight">Precision Auto Repair</h1>
                                        </div>
                                        <div className="text-sm text-slate-500 dark:text-slate-400 space-y-1">
                                            <p>123 Mechanics Lane, Suite 101</p>
                                            <p>Los Angeles, CA 90210</p>
                                            <p>+1 (555) 987-6543</p>
                                        </div>
                                    </div>
                                    <div className="flex flex-col md:items-end gap-3">
                                        <div className="flex items-center gap-3">
                                            {estimate.paid && (
                                                <div className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 px-3 py-1 rounded-md text-xs font-bold uppercase tracking-wider flex items-center gap-1.5 border border-emerald-200 dark:border-emerald-800">
                                                    <span className="size-2 rounded-full bg-emerald-500"></span> Paid
                                                </div>
                                            )}
                                            <span className="text-2xl font-black text-slate-900 dark:text-white">#{estimate.id}</span>
                                        </div>
                                        <div className="text-sm text-slate-500 dark:text-slate-400 space-y-1 md:text-right">
                                            <p>Invoice Date: <span className="text-slate-900 dark:text-white font-semibold">{estimate.date}</span></p>
                                            <p>Status: <span className="capitalize">{estimate.status}</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-800">
                                <div className="p-8 md:p-12 border-b md:border-b-0 md:border-r border-slate-100 dark:border-slate-800">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Bill To</h3>
                                    <p className="text-lg font-bold">{estimate.customer}</p>
                                    <p className="text-sm text-slate-500">{estimate.phone}</p>
                                </div>
                                <div className="p-8 md:p-12">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Vehicle Details</h3>
                                    <div className="grid grid-cols-2 gap-y-2 text-sm">
                                        <span className="text-slate-500 font-medium">Make/Model:</span>
                                        <span className="font-bold">{estimate.vehicle}</span>
                                        <span className="text-slate-500 font-medium">Service:</span>
                                        <span className="font-bold">{estimate.service}</span>
                                    </div>
                                </div>
                            </div>
                            <div className="p-8 md:p-12">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="text-slate-400 text-xs font-bold uppercase border-b border-slate-200 dark:border-slate-700">
                                            <th className="pb-4">Service / Parts</th>
                                            <th className="pb-4 text-center">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 dark:divide-slate-800">
                                        <tr>
                                            <td className="py-6"><p className="font-bold">Labor Charges</p></td>
                                            <td className="py-6 text-right font-bold">${Number(estimate.laborCost).toFixed(2)}</td>
                                        </tr>
                                        <tr>
                                            <td className="py-6"><p className="font-bold">Parts & Materials</p></td>
                                            <td className="py-6 text-right font-bold">${Number(estimate.partsCost).toFixed(2)}</td>
                                        </tr>
                                        {Number(estimate.tax) > 0 && (
                                            <tr>
                                                <td className="py-6"><p className="font-bold text-slate-500">Tax</p></td>
                                                <td className="py-6 text-right font-bold text-slate-500">${Number(estimate.tax).toFixed(2)}</td>
                                            </tr>
                                        )}
                                        <tr className="text-xl">
                                            <td className="pt-6 font-black text-right pr-10">Total</td>
                                            <td className="pt-6 text-right font-black text-primary">${Number(estimate.amount).toFixed(2)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                {estimate.notes && (
                                    <div className="mt-8 p-4 bg-yellow-50 dark:bg-yellow-900/10 text-yellow-800 dark:text-yellow-200 rounded-lg text-sm">
                                        <strong>Mechanic Notes:</strong> {estimate.notes}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </Layout>
            );
        };

        const SuccessScreen = () => {
            const navigate = useNavigate();
            return (
                <Layout hideNav>
                    <div className="flex-1 flex items-center justify-center py-10 px-4 animate-[fadeIn_0.5s_ease-out]">
                        <div className="max-w-[520px] w-full bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-8 flex flex-col items-center">
                            <div className="bg-primary/10 p-6 rounded-full mb-6">
                                <span className="material-symbols-outlined text-primary !text-7xl font-light">check_circle</span>
                            </div>
                            <h1 className="text-3xl font-bold tracking-tight text-center">Success!</h1>
                            <p className="text-gray-600 dark:text-gray-400 text-center mt-3">The action was completed successfully.</p>
                            <button onClick={() => navigate('/dashboard')} className="w-full bg-primary text-white font-semibold py-4 rounded-lg mt-8 flex items-center justify-center gap-2 hover:bg-primary/90 transition-colors">
                                <span className="material-symbols-outlined">home</span> Back to Dashboard
                            </button>
                        </div>
                    </div>
                </Layout>
            );
        };

        const SettingsScreen = () => {
            const navigate = useNavigate();
            return (
                <Layout>
                    <main className="flex flex-1 justify-center py-10 px-4 md:px-0">
                        <div className="layout-content-container flex flex-col max-w-[640px] flex-1 bg-white dark:bg-gray-900/50 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-6 md:p-10 mb-20 animate-[slideIn_0.3s_ease-out]">
                            <div className="flex flex-col gap-2 mb-8 border-b border-gray-100 dark:border-gray-800 pb-6">
                                <Link to="/dashboard" className="flex items-center gap-2 text-primary mb-2 text-sm font-semibold uppercase tracking-wider">
                                    <span className="material-symbols-outlined text-sm">arrow_back</span> Back to Dashboard
                                </Link>
                                <h1 className="text-3xl font-black tracking-tight">Business Settings</h1>
                                <p className="text-[#617589] dark:text-gray-400">Manage your professional details and invoice preferences.</p>
                            </div>
                            <form className="flex flex-col gap-8" onSubmit={(e) => { e.preventDefault(); alert('Settings Saved'); navigate('/dashboard'); }}>

                                <section>
                                    <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-primary border-b dark:border-gray-800 pb-2">
                                        <span className="material-symbols-outlined">storefront</span> Business Info
                                    </h3>
                                    <div className="flex flex-col gap-4">
                                        <div className="flex flex-col gap-2">
                                            <label className="text-sm font-semibold">Business Name</label>
                                            <input className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-10 px-3" defaultValue="Precision Auto Repair" type="text" />
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <label className="text-sm font-semibold">Phone Number</label>
                                            <input className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-10 px-3" defaultValue="(555) 123-4567" type="tel" />
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <label className="text-sm font-semibold">Business Address</label>
                                            <input className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-10 px-3" defaultValue="123 Mechanics Lane, Los Angeles, CA" type="text" />
                                        </div>
                                    </div>
                                </section>

                                <section>
                                    <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-primary border-b dark:border-gray-800 pb-2">
                                        <span className="material-symbols-outlined">receipt_long</span> Invoice Details
                                    </h3>
                                    <div className="flex flex-col gap-4">
                                        <div className="flex flex-col gap-2">
                                            <label className="text-sm font-semibold">Currency Symbol</label>
                                            <select className="form-select rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-10 px-3">
                                                <option value="$">USD ($)</option>
                                                <option value="">NGN ()</option>
                                                <option value="">EUR ()</option>
                                                <option value="">GBP ()</option>
                                            </select>
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <label className="text-sm font-semibold">Default Tax Rate (%)</label>
                                            <input className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-10 px-3" defaultValue="8.25" type="number" />
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <label className="text-sm font-semibold">Invoice Footer Text</label>
                                            <textarea className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 min-h-24 p-3" defaultValue="Thank you for your business! All parts come with a 12-month warranty." />
                                        </div>
                                    </div>
                                </section>

                                <section>
                                    <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-primary border-b dark:border-gray-800 pb-2">
                                        <span className="material-symbols-outlined">tune</span> App Preferences
                                    </h3>
                                    <div className="flex flex-col gap-4">
                                        <div className="flex items-center justify-between">
                                            <label className="text-sm font-semibold">Dark Mode</label>
                                            <input type="checkbox" className="toggle" defaultChecked onChange={(e) => document.documentElement.classList.toggle('dark')} />
                                        </div>
                                        <div className="flex items-center justify-between">
                                            <label className="text-sm font-semibold">Push Notifications</label>
                                            <input type="checkbox" className="toggle" defaultChecked />
                                        </div>
                                    </div>
                                </section>

                                <div className="flex items-center justify-end gap-4 pt-6 border-t border-gray-100 dark:border-gray-800">
                                    <button onClick={() => navigate('/dashboard')} className="px-6 py-3 rounded-lg text-sm font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800">Discard</button>
                                    <button className="bg-primary text-white px-8 py-3 rounded-lg text-sm font-bold shadow-lg shadow-primary/20 hover:bg-primary/90" type="submit">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </main>
                </Layout>
            );
        };

        const OfflineErrorScreen = () => {
            const navigate = useNavigate();
            return (
                <Layout hideNav>
                    <main className="flex-grow flex items-center justify-center p-6 min-h-screen">
                        <div className="w-full max-w-[480px] bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-8">
                            <div className="flex flex-col items-center text-center gap-8">
                                <div className="relative flex items-center justify-center w-full aspect-video bg-red-50 dark:bg-red-900/10 rounded-xl overflow-hidden">
                                    <div className="flex flex-col items-center">
                                        <span className="material-symbols-outlined text-red-500 text-7xl mb-2">wifi_off</span>
                                    </div>
                                </div>
                                <div className="flex flex-col gap-3">
                                    <h1 className="text-[#111418] dark:text-white text-2xl font-bold tracking-tight">Manual Mode</h1>
                                    <p className="text-gray-600 dark:text-gray-400 text-base leading-relaxed">
                                        Since this is a demo, you can't create an estimate here. Go to the Customer View to submit a new request.
                                    </p>
                                </div>
                                <div className="flex flex-col w-full gap-4">
                                    <button onClick={() => navigate('/request')} className="flex w-full items-center justify-center rounded-lg h-12 bg-primary text-white font-bold hover:bg-primary/90">
                                        Go to Customer Form
                                    </button>
                                    <button onClick={() => navigate('/dashboard')} className="flex w-full items-center justify-center rounded-lg h-12 bg-gray-100 dark:bg-gray-800 text-[#111418] dark:text-white text-sm font-semibold">
                                        Back to Dashboard
                                    </button>
                                </div>
                            </div>
                        </div>
                    </main>
                </Layout>
            );
        };

        const ProcessingScreen = () => {
            const navigate = useNavigate();
            const { id } = useParams();
            const [progress, setProgress] = useState(0);

            useEffect(() => {
                // Animate progress bar
                const interval = setInterval(() => {
                    setProgress(old => {
                        const newProgress = old + Math.random() * 15;
                        if (newProgress >= 100) {
                            clearInterval(interval);
                            return 100;
                        }
                        return newProgress;
                    });
                }, 300);

                const timer = setTimeout(() => navigate('/invoice/' + id), 2500);
                return () => {
                    clearTimeout(timer);
                    clearInterval(interval);
                }
            }, [id]);

            return (
                <Layout hideNav hideHeader>
                    <div className="flex flex-1 items-center justify-center p-4 min-h-screen">
                        <div className="w-full max-w-[500px]">
                            <div className="flex flex-col items-stretch justify-start rounded-xl shadow-xl bg-white dark:bg-[#1c2631] border border-[#f0f2f4] dark:border-[#2a343d] overflow-hidden">
                                <div className="w-full h-48 bg-primary/10 flex items-center justify-center relative overflow-hidden">
                                    <div className="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-primary via-transparent to-transparent"></div>
                                    <div className="flex flex-col items-center gap-4 relative z-10">
                                        <div className="animate-spin rounded-full h-16 w-16 border-4 border-primary/20 border-t-primary"></div>
                                        <span className="material-symbols-outlined text-primary scale-animation" style={{ fontSize: '40px', position: 'absolute', top: '24px' }}>description</span>
                                    </div>
                                </div>
                                <div className="flex w-full grow flex-col items-stretch justify-center gap-6 py-8 px-8">
                                    <div className="space-y-2">
                                        <h1 className="text-2xl font-bold tracking-tight text-center">Generating Invoice...</h1>
                                        <p className="text-[#617589] dark:text-gray-400 text-center">We're preparing your professional PDF invoice for the repair work.</p>
                                    </div>
                                    <div className="flex flex-col gap-3">
                                        <div className="flex gap-6 justify-between items-center">
                                            <p className="text-sm font-medium">Overall Progress</p>
                                            <p className="text-primary text-sm font-bold">{Math.round(progress)}%</p>
                                        </div>
                                        <div className="rounded-full bg-[#dbe0e6] dark:bg-[#2a343d] h-2 overflow-hidden">
                                            <div className="h-full bg-primary transition-all duration-300 ease-out" style={{ width: `${progress}%` }}></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </Layout>
            );
        };



        // --- Main App ---


        const HistoryScreen = () => {
            const navigate = useNavigate();
            const location = useLocation();
            const searchParams = new URLSearchParams(location.search);
            const customerFilter = searchParams.get('customer');

            const [history, setHistory] = useState([]);

            useEffect(() => {
                const allEstimates = Store.getEstimates();
                if (customerFilter) {
                    setHistory(allEstimates.filter(e => e.customer === customerFilter));
                } else {
                    setHistory(allEstimates);
                }
            }, [customerFilter]);

            return (
                <Layout>
                    <main className="flex justify-center py-6 px-4 pb-28">
                        <div className="w-full max-w-[600px] flex flex-col gap-6">
                            <div className="flex flex-col gap-1">
                                <div className="flex items-center gap-2">
                                    {customerFilter && (
                                        <button onClick={() => navigate(-1)} className="material-symbols-outlined text-gray-500 hover:text-black dark:hover:text-white">arrow_back</button>
                                    )}
                                    <h2 className="text-2xl font-bold tracking-tight">{customerFilter ? `History: ${customerFilter}` : 'Service History'}</h2>
                                </div>
                                <p className="text-[#617589] text-sm">{customerFilter ? `Past jobs for ${customerFilter}` : 'Past estimates and invoices.'}</p>
                            </div>

                            {history.length === 0 ? (
                                <div className="text-center py-10 bg-white dark:bg-gray-900 rounded-xl border border-dashed border-gray-300 dark:border-gray-700">
                                    <p className="text-gray-500">No history found.</p>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-4">
                                    {history.map(est => (
                                        <div key={est.id}
                                            onClick={() => navigate(`/invoice/${est.id}`)}
                                            className="cursor-pointer bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-[#f0f2f4] dark:border-gray-800 overflow-hidden flex transition-all hover:bg-gray-50 dark:hover:bg-gray-800">
                                            <div className="w-24 bg-cover bg-center shrink-0" style={{ backgroundImage: `url(${est.img})` }}></div>
                                            <div className="flex-1 p-3 flex flex-col justify-center gap-1">
                                                <div className="flex justify-between items-center">
                                                    <h3 className="font-bold text-[#111418] dark:text-white text-sm">{est.customer}</h3>
                                                    <span className="text-xs text-gray-500">{est.date}</span>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <p className="text-xs text-gray-500">{est.vehicle}</p>
                                                    <StatusBadge status={est.status} />
                                                </div>
                                                <div className="mt-1">
                                                    <span className="text-sm font-bold text-primary">${Number(est.amount).toFixed(2)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </main>
                </Layout>
            );
        };

        const CustomersScreen = () => {
            const navigate = useNavigate();
            const [customers, setCustomers] = useState([]);

            const refreshCustomers = React.useCallback(() => {
                const estimates = Store.getEstimates();
                const users = Store.getUsers();
                const uniqueCustomers = [];
                const map = new Map();
                for (const item of estimates) {
                    if (!map.has(item.customer)) {
                        // Attempt to resolve the real user to get their Key
                        const linkedUser = users.find(u =>
                            (item.customerKey && u.shareKey === item.customerKey) ||
                            u.phone === item.phone ||
                            u.name === item.customer
                        );

                        const customerWithKey = Object.assign({}, item, {
                            shareKey: linkedUser ? linkedUser.shareKey : (item.customerKey || null)
                        });

                        map.set(item.customer, customerWithKey);
                        uniqueCustomers.push(customerWithKey);
                    }
                }
                setCustomers(uniqueCustomers);
            }, []);

            useEffect(() => {
                refreshCustomers();
            }, [refreshCustomers]);

            const handleDelete = (name) => {
                if (window.confirm(`Archive customer "${name}" and all their history? This will mark all requests as archived.`)) {
                    Store.deleteCustomer(name);
                    refreshCustomers();
                }
            };

            return (
                <Layout>
                    <main className="flex justify-center py-6 px-4 pb-28">
                        <div className="w-full max-w-[600px] flex flex-col gap-6">
                            <div className="flex flex-col gap-1">
                                <h2 className="text-2xl font-bold tracking-tight">My Customers</h2>
                                <p className="text-[#617589] text-sm">Contact list and unique access keys.</p>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {customers.length === 0 ? (
                                    <div className="col-span-2 text-center text-gray-500 py-10">No customers found.</div>
                                ) : (
                                    customers.map((cust, idx) => (
                                        <div key={idx} className="bg-white dark:bg-gray-900 rounded-xl p-4 border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col items-center text-center gap-3 hover:shadow-md transition-shadow relative overflow-hidden">
                                            {cust.shareKey && (
                                                <div className="absolute top-0 right-0 p-2">
                                                    <span className="bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 text-[10px] font-bold px-2 py-0.5 rounded-full font-mono">
                                                        {cust.shareKey}
                                                    </span>
                                                </div>
                                            )}

                                            <div className="size-16 rounded-full bg-gray-100 dark:bg-gray-800 overflow-hidden mt-2">
                                                <img src={`https://ui-avatars.com/api/?name=${cust.customer.replace(' ', '+')}&background=random`} alt={cust.customer} className="w-full h-full object-cover" />
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-lg leading-tight">{cust.customer}</h3>
                                                <p className="text-sm text-gray-500">{cust.phone}</p>
                                            </div>

                                            {cust.shareKey && (
                                                <div className="flex items-center gap-1 bg-gray-50 dark:bg-gray-800/50 px-3 py-1.5 rounded-lg border border-gray-100 dark:border-gray-700 w-full justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                                    onClick={() => { navigator.clipboard.writeText(cust.shareKey); alert('Key copied: ' + cust.shareKey); }}>
                                                    <span className="material-symbols-outlined text-gray-400 text-xs">key</span>
                                                    <span className="text-xs font-mono font-bold text-gray-700 dark:text-gray-300">Key: {cust.shareKey}</span>
                                                </div>
                                            )}

                                            <div className="w-full pt-1">
                                                <div className="flex items-center justify-center gap-2 text-xs text-gray-400 pb-2">
                                                    <span className="material-symbols-outlined text-sm">directions_car</span>
                                                    {cust.vehicle}
                                                </div>
                                            </div>

                                            <div className="flex flex-col w-full gap-2 mt-auto">
                                                <button
                                                    onClick={() => navigate(`/history?customer=${encodeURIComponent(cust.customer)}`)}
                                                    className="w-full py-2 text-primary text-sm font-bold hover:bg-primary/5 rounded-lg transition-colors cursor-pointer border border-primary/10">
                                                    View History
                                                </button>
                                                <button
                                                    onClick={() => handleDelete(cust.customer)}
                                                    className="w-full py-2 text-red-500 text-sm font-bold hover:bg-red-50 dark:hover:bg-red-900/10 rounded-lg transition-colors cursor-pointer">
                                                    Archive
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </main>
                </Layout>
            );
        };

        const ProfileScreen = () => {
            const navigate = useNavigate();
            return (
                <Layout>
                    <main className="flex justify-center py-10 px-4 pb-28">
                        <div className="w-full max-w-[500px] flex flex-col gap-6">
                            <div className="bg-white dark:bg-gray-900 rounded-xl p-8 border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col items-center">
                                <div className="relative mb-4">
                                    <div className="size-24 rounded-full bg-cover bg-center border-4 border-gray-50 dark:border-gray-800" style={{ backgroundImage: 'url("https://ui-avatars.com/api/?name=Mechanic&background=0D8ABC&color=fff")' }}></div>
                                    <button className="absolute bottom-0 right-0 bg-primary text-white rounded-full p-1.5 shadow-md hover:bg-blue-600 transition-colors">
                                        <span className="material-symbols-outlined text-sm">edit</span>
                                    </button>
                                </div>
                                <h1 className="text-2xl font-bold">John Mechanic</h1>
                                <p className="text-gray-500">Shop Owner  Precision Auto Repair</p>

                                <div className="flex gap-4 w-full mt-6 border-t border-gray-100 dark:border-gray-800 pt-6">
                                    <div className="flex-1 text-center">
                                        <span className="block text-xl font-bold text-primary">124</span>
                                        <span className="text-xs text-gray-500 uppercase tracking-wide">Jobs Done</span>
                                    </div>
                                    <div className="flex-1 text-center border-l border-gray-100 dark:border-gray-800">
                                        <span className="block text-xl font-bold text-primary">4.9</span>
                                        <span className="text-xs text-gray-500 uppercase tracking-wide">Rating</span>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white dark:bg-gray-900 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm overflow-hidden">
                                <div className="p-4 border-b border-gray-50 dark:border-gray-800 font-bold">Account Details</div>
                                <div className="p-6 flex flex-col gap-4">
                                    <div className="flex flex-col gap-2">
                                        <label className="text-sm font-semibold">Full Name</label>
                                        <input className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-10 px-3" defaultValue="John Mechanic" type="text" />
                                    </div>
                                    <div className="flex flex-col gap-2">
                                        <label className="text-sm font-semibold">Email</label>
                                        <input className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-10 px-3" defaultValue="mechanic@example.com" type="email" />
                                    </div>
                                    <div className="pt-2">
                                        <button className="text-primary text-sm font-bold hover:underline">Change Password</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </Layout>
            )
        }

        const NotificationsScreen = () => {
            const [notifications, setNotifications] = useState([
                { id: 1, title: 'New Request', message: 'Sarah Smith requested an estimate for Engine Diagnostic', time: '2 mins ago', read: false },
                { id: 2, title: 'Invoice Paid', message: 'Invoice #EST-9012 was paid by John Doe', time: '1 hour ago', read: false },
                { id: 3, title: 'System Update', message: 'MechFlow has been updated to version 2.0', time: '1 day ago', read: true },
            ]);

            const markRead = (id) => {
                setNotifications(notifications.map(n => n.id === id ? Object.assign({}, n, { read: true }) : n));
            }

            return (
                <Layout>
                    <main className="flex justify-center py-6 px-4 pb-28">
                        <div className="w-full max-w-[600px] flex flex-col gap-6">
                            <div className="flex items-center justify-between">
                                <h2 className="text-2xl font-bold tracking-tight">Notifications</h2>
                                <button className="text-primary text-sm font-bold" onClick={() => setNotifications(notifications.map(n => Object.assign({}, n, { read: true })))}>Mark all read</button>
                            </div>

                            <div className="flex flex-col gap-3">
                                {notifications.map(notif => (
                                    <div key={notif.id} onClick={() => markRead(notif.id)} className={`bg-white dark:bg-gray-900 p-4 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex items-start gap-3 cursor-pointer transition-colors ${!notif.read ? 'border-l-4 border-l-primary bg-blue-50/50 dark:bg-blue-900/10' : 'hover:bg-gray-50 dark:hover:bg-gray-800'}`}>
                                        <div className={`mt-1 p-2 rounded-full ${!notif.read ? 'bg-primary/20 text-primary' : 'bg-gray-100 text-gray-500'}`}>
                                            <span className="material-symbols-outlined text-sm">notifications</span>
                                        </div>
                                        <div className="flex-1">
                                            <div className="flex justify-between items-start">
                                                <h3 className={`text-sm ${!notif.read ? 'font-bold' : 'font-semibold'}`}>{notif.title}</h3>
                                                <span className="text-xs text-gray-400">{notif.time}</span>
                                            </div>
                                            <p className="text-sm text-gray-600 dark:text-gray-400 mt-0.5">{notif.message}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>
                </Layout>
            )
        }

        const App = () => {
            return (
                <MemoryRouter>
                    <Routes>
                        <Route path="/" element={<LoginScreen />} />
                        <Route path="/dashboard" element={<DashboardScreen />} />
                        <Route path="/create-estimate" element={<CreateEstimateScreen />} />
                        <Route path="/review/:id" element={<ReviewScreen />} />
                        <Route path="/processing/:id" element={<ProcessingScreen />} />
                        <Route path="/invoice/:id" element={<InvoiceScreen />} />
                        <Route path="/success" element={<SuccessScreen />} />
                        <Route path="/settings" element={<SettingsScreen />} />
                        <Route path="/offline-error" element={<OfflineErrorScreen />} />
                        <Route path="/login" element={<LoginScreen />} />

                        <Route path="/history" element={<HistoryScreen />} />
                        <Route path="/customers" element={<CustomersScreen />} />
                        <Route path="/profile" element={<ProfileScreen />} />
                        <Route path="/notifications" element={<NotificationsScreen />} />
                        {/* Route path="/status/:id" element={<CustomerStatusScreen />} / */}
                    </Routes>
                </MemoryRouter>
            );
        };

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>

</html>