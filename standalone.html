<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <script src="session.js"></script>
    <title>Mechanic PRO - Terminal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;300;400;700;900&family=Plus+Jakarta+Sans:wght@200;400;600;800&display=swap"
        rel="stylesheet">
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#007AFF",
                        "whatsapp": "#25D366",
                        "background-light": "#050505",
                        "background-dark": "#000000",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"],
                        "heading": ["Outfit", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "4px", "lg": "8px", "xl": "12px", "2xl": "16px", "full": "9999px" },
                },
            },
        }
    </script>
    <link id="favicon-link" rel="icon" type="image/png" href="assets/emojis/male/008.png">
    <style>
        :root {
            --accent: #007AFF;
            --accent-glow: rgba(0, 122, 255, 0.4);
            --bg-pure: #000000;
            --bg-elevated: #050505;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --border-color: rgba(255, 255, 255, 0.1);
        }

        #root {
            width: 100%;
            height: 100%;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-pure);
            color: var(--text-primary);
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Outfit', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .fill-1 {
            font-variation-settings: 'FILL' 1;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }

            to {
                transform: translateY(0);
            }
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse-soft {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .animate-slide-up {
            animation: slideUp 0.6s ease-out forwards;
        }

        .animate-slide-down {
            animation: slideDown 0.4s ease-out forwards;
        }

        .animate-zoom-in {
            animation: zoomIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-[#111418] dark:text-white transition-colors duration-200">
    <div id="root">
        <div
            style="position:fixed;inset:0;background:#000;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center">
            <div id="loading-text"
                style="font-family:'Outfit',sans-serif;font-weight:900;font-size:2rem;letter-spacing:0.1em;color:white;margin-bottom:1.5rem;text-transform:uppercase;">
                MECHFLOW
            </div>
            <div style="width:12rem;height:1px;background:rgba(255,255,255,0.1);position:relative;overflow:hidden">
                <div
                    style="position:absolute;inset:0;background:#007AFF;width:50%;animation:sidebarLoader 1s infinite linear">
                </div>
            </div>
            <div
                style="font-size:10px;color:rgba(255,255,255,0.4);font-weight:bold;letter-spacing:0.3em;text-transform:uppercase;margin-top:1.5rem">
                Initializing Interface
            </div>
            <style>
                @keyframes sidebarLoader {
                    0% {
                        transform: translateX(-100%);
                    }

                    100% {
                        transform: translateX(200%);
                    }
                }
            </style>
        </div>
    </div>
    <script>
        try {
            const settings = JSON.parse(localStorage.getItem('mechflow_settings') || '{}');
            // Update Favicon
            if (settings.businessLogo) {
                const fav = document.getElementById('favicon-link');
                if (fav) fav.href = settings.businessLogo;
            }
            // Update Loading Text
            if (settings.businessName) {
                const textEl = document.getElementById('loading-text');
                if (textEl) textEl.innerText = settings.businessName;
            }
        } catch (e) { console.error('Error loading brand settings', e); }
    </script>

    <!-- React and Dependencies -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            // Prevent silent black screens by showing the error
            if (document.getElementById('root') && document.getElementById('root').innerHTML === '') {
                document.body.innerHTML = '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:#111;color:#ff5555;padding:40px;font-family:monospace;z-index:9999;overflow:auto"><h1>System Error</h1><p style="font-size:1.2em">' + msg + '</p><p>Location: ' + url + ':' + line + '</p><button onclick="window.location.reload()" style="background:#fff;color:#000;padding:10px 20px;border:none;border-radius:4px;cursor:pointer;margin-top:20px;font-weight:bold">Reload Terminal</button></div>';
            }
        };
    </script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/history@5/umd/history.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-router@6.3.0/umd/react-router.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="store.js"></script>

    <script type="text/babel">
        // Ensure React Router is available before proceeding
        if (!window.ReactRouterDOM) {
            throw new Error("Critical Dependency Error: React Router DOM failed to load.");
        }
        const { useState, useEffect, useMemo } = React;
        const { createRoot } = ReactDOM;
        const { MemoryRouter, Routes, Route, Link, useNavigate, useLocation, useParams } = ReactRouterDOM;

        // Data & State Management logic imported from store.js
        const Store = window.Store;
        try {
            if (Store && Store.init) {
                Store.init();
            }
        } catch (e) { console.error(e); }



        // --- Components ---

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught an error", error, errorInfo);
                this.setState({ error: error });
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex items-center justify-center min-h-screen bg-gray-100 text-[#111418] p-4 font-sans">
                            <div className="bg-white p-8 rounded-xl shadow-xl max-w-md w-full border border-gray-200 text-center">
                                <div className="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-red-100 mb-6">
                                    <span className="material-symbols-outlined text-3xl text-red-600">error</span>
                                </div>
                                <h1 className="text-xl font-bold text-gray-900 mb-2">Something went wrong</h1>
                                <p className="text-gray-500 mb-6 text-sm">We realized there was an error.</p>
                                <details className="text-left text-xs text-red-500 bg-red-50 p-2 rounded mb-4 overflow-auto max-h-32">
                                    <summary>Error Details</summary>
                                    <p className="font-mono mt-2">{this.state.error && this.state.error.toString()}</p>
                                </details>
                                <button
                                    onClick={() => window.location.reload()}
                                    className="w-full bg-primary text-white px-4 py-3 rounded-lg font-bold hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
                                >
                                    <span className="material-symbols-outlined text-sm">refresh</span>
                                    Reload Application
                                </button>
                            </div>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        const NotificationToast = ({ notification, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 8000);
                return () => clearTimeout(timer);
            }, []);

            return (
                <div className="fixed top-6 right-6 z-[100] w-full max-w-sm animate-slide-left no-print">
                    <div className="bg-[#111418] border border-blue-500/30 rounded-2xl shadow-2xl p-5 flex items-start gap-4 ring-1 ring-white/10 backdrop-blur-xl">
                        <div className="size-12 rounded-2xl bg-blue-600 flex items-center justify-center shrink-0 shadow-lg shadow-blue-600/20">
                            <span className="material-symbols-outlined text-white text-2xl">pending_actions</span>
                        </div>
                        <div className="flex-1 min-w-0">
                            <div className="flex justify-between items-start mb-1">
                                <h4 className="text-sm font-black text-white uppercase tracking-wider">{notification.title}</h4>
                                <span className="text-[10px] text-gray-500 font-bold uppercase">{notification.time}</span>
                            </div>
                            <p className="text-xs text-gray-400 leading-relaxed line-clamp-2">{notification.message}</p>
                            <div className="mt-3 flex gap-2">
                                <button
                                    onClick={() => { window.location.hash = '#/dashboard'; onClose(); }}
                                    className="px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-lg text-[10px] font-bold text-white transition-colors uppercase tracking-widest"
                                >
                                    Dismiss
                                </button>
                                <button
                                    onClick={() => { if (notification.data && notification.data.id) window.location.hash = `#/review/${notification.data.id}`; onClose(); }}
                                    className="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded-lg text-[10px] font-bold text-white transition-colors uppercase tracking-widest"
                                >
                                    Open Request
                                </button>
                            </div>
                        </div>
                        <button onClick={onClose} className="text-gray-600 hover:text-white transition-colors">
                            <span className="material-symbols-outlined text-lg">close</span>
                        </button>
                    </div>
                </div>
            );
        };

        const PageLoader = () => (
            <div className="fixed inset-0 bg-[#000000] z-[9999] flex flex-col items-center justify-center">
                <div className="relative flex flex-col items-center gap-6">
                    <div style={{ fontFamily: 'Outfit', fontWeight: 900, fontSize: '1.5rem', letterSpacing: '0.2em', color: 'white', textTransform: 'uppercase' }}>
                        {Store.getSettings().businessName || 'MECHFLOW'}
                    </div>
                    <div className="w-48 h-[1px] bg-white/10 relative overflow-hidden">
                        <div className="absolute inset-0 bg-blue-500 w-1/2 animate-[sidebarLoader_1s_infinite_linear]"></div>
                    </div>
                    <div className="text-[10px] text-white/40 font-bold tracking-[0.3em] uppercase">Loading Terminal</div>
                </div>
                <style>{`
                    @keyframes sidebarLoader {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(200%); }
                    }
                `}</style>
            </div>
        );

        const DigitalClock = ({ className = "" }) => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            return (
                <div className={`flex flex-col items-end ${className}`}>
                    <div className="flex items-center gap-2">
                        <span className="relative flex h-2 w-2">
                            <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                            <span className="relative inline-flex rounded-full h-2 w-2 bg-primary"></span>
                        </span>
                        <span className="text-[10px] font-black text-primary uppercase tracking-[0.2em]">Terminal Time</span>
                    </div>
                    <span className="text-xl font-black dark:text-white font-mono tabular-nums leading-none tracking-tighter">
                        {time.toLocaleTimeString([], { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' })}
                    </span>
                    <span className="text-[9px] font-bold text-gray-500 uppercase tracking-[0.1em] mt-0.5">
                        {time.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}
                    </span>
                </div>
            );
        };

        const Layout = ({ children, hideNav, hideHeader }) => {
            const location = useLocation();
            const navigate = useNavigate();
            const activePath = location.pathname;
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const user = Store.getCurrentUser();
            const showBack = activePath !== '/dashboard' && activePath !== '/';
            const [loading, setLoading] = useState(false);
            const [toast, setToast] = useState(null);
            const [unreadCount, setUnreadCount] = useState(0);
            const [showPermissionPrompt, setShowPermissionPrompt] = useState(false);
            const [shopStatus, setShopStatus] = useState(Store.getShopStatus());
            const [settings, setSettings] = useState(Store.getSettings());
            const [userMenuOpen, setUserMenuOpen] = useState(false);

            useEffect(() => {
                const dismissed = sessionStorage.getItem('mechflow_notif_dismissed');
                if ("Notification" in window && Notification.permission === "default" && user && !dismissed) {
                    setShowPermissionPrompt(true);
                }
            }, [user && user.email]);

            useEffect(() => {
                const updateCounts = () => {
                    const all = Store.getNotifications('mechanic');
                    setUnreadCount(all.filter(n => !n.read).length);
                };

                updateCounts();
                const unsubscribe = Store.subscribe((event) => {
                    if (event.type === 'NOTIFICATION_ADDED' && event.notification.role === 'mechanic') {
                        setToast(event.notification);
                        updateCounts();
                    }
                    if (event.type === 'STORAGE_UPDATED' && event.key === 'mechflow_notifications') {
                        updateCounts();
                    }
                    if (event.type === 'NOTIFICATION_UPDATED') updateCounts();
                    if (event.type === 'SHOP_STATUS_UPDATED') setShopStatus(event.status);
                    if (event.type === 'SETTINGS_UPDATED') {
                        setSettings(event.settings);
                        document.title = `${event.settings.businessName} - Mechanic Terminal`;
                    }
                    if (event.type === 'STORAGE_UPDATED' && (event.key === 'mechflow_shop_status' || event.key === 'mechflow_settings')) {
                        setShopStatus(Store.getShopStatus());
                        const s = Store.getSettings();
                        setSettings(s);
                        document.title = `${s.businessName} - Mechanic Terminal`;
                    }
                });

                document.title = `${settings.businessName} - Mechanic Terminal`;

                setLoading(true);
                const timer = setTimeout(() => setLoading(false), 600);
                return () => {
                    clearTimeout(timer);
                    unsubscribe();
                };
            }, [location.pathname]);

            // Close sidebar on navigation on mobile
            useEffect(() => {
                setSidebarOpen(false);
            }, [activePath]);

            useEffect(() => {
                if (!user && activePath !== '/login' && activePath !== '/') {
                    navigate('/login');
                }
            }, [user, activePath]);

            if (!user) return null;

            return (
                <div className="flex h-screen bg-gray-50 dark:bg-background-dark overflow-hidden">
                    {/* Permission Prompt Banner */}
                    {showPermissionPrompt && (
                        <div className="fixed top-0 left-0 right-0 z-[100] bg-primary text-white p-3 flex items-center justify-center gap-4 animate-slide-down no-print">
                            <span className="material-symbols-outlined">notifications_active</span>
                            <p className="text-sm font-bold uppercase tracking-wider">Enable Workshop Alerts on this device?</p>
                            <div className="flex gap-2">
                                <button
                                    onClick={async () => {
                                        const granted = await Store.requestNotificationPermission();
                                        if (granted) alert('Notifications enabled!');
                                        sessionStorage.setItem('mechflow_notif_dismissed', 'true');
                                        setShowPermissionPrompt(false);
                                    }}
                                    className="bg-white text-primary px-4 py-1.5 rounded-lg text-[10px] font-black uppercase"
                                >
                                    Enable
                                </button>
                                <button onClick={() => {
                                    sessionStorage.setItem('mechflow_notif_dismissed', 'true');
                                    setShowPermissionPrompt(false);
                                }} className="bg-white/20 text-white px-4 py-1.5 rounded-lg text-[10px] font-bold uppercase">Maybe Later</button>
                            </div>
                        </div>
                    )}

                    {loading && <PageLoader />}
                    {toast && <NotificationToast notification={toast} onClose={() => setToast(null)} />}

                    {/* Sidebar Overlay */}
                    {!hideNav && sidebarOpen && (
                        <div
                            className="fixed inset-0 bg-black/50 z-40 lg:hidden backdrop-blur-sm transition-opacity"
                            onClick={() => setSidebarOpen(false)}
                        ></div>
                    )}

                    {/* Sidebar */}
                    {!hideNav && (
                        <aside className={`
                            fixed lg:static inset-y-0 left-0 z-50 w-72 bg-[#111418] dark:bg-gray-900 text-white transform transition-transform duration-300 ease-in-out
                            ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
                            flex flex-col h-full shadow-2xl lg:shadow-none
                        `}>
                            {/* Logo */}
                            <div className="p-6 flex items-center gap-3">
                                <div className="size-10 rounded-xl overflow-hidden border border-white/20 shadow-lg">
                                    <img src={settings.businessLogo} className="w-full h-full object-cover scale-[1.8] relative top-2" />
                                </div>
                                <div className="flex flex-col">
                                    <h1 className="font-black text-lg tracking-tight leading-none text-white uppercase">{settings.businessName}</h1>
                                    <p className="text-[8px] text-primary font-black tracking-[0.2em] uppercase mt-1">Automotive Terminal</p>
                                </div>
                            </div>

                            {/* Nav Links */}
                            <div className="flex-1 overflow-y-auto py-6 px-4 space-y-1">
                                <Link to="/dashboard" className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/dashboard' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <span className="material-symbols-outlined">dashboard</span>
                                    Dashboard
                                </Link>
                                <Link to="/create-estimate" className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/create-estimate' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <span className="material-symbols-outlined">add_circle</span>
                                    New Estimate
                                </Link>
                                <Link to="/history" className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/history' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <span className="material-symbols-outlined">history</span>
                                    History
                                </Link>
                                <Link to="/customers" className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/customers' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <span className="material-symbols-outlined">group</span>
                                    Customers
                                </Link>
                                <div className="pt-6 pb-2">
                                    <p className="px-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Settings</p>
                                </div>
                                <Link to="/profile" className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/profile' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <span className="material-symbols-outlined">person</span>
                                    Profile
                                </Link>
                                <Link to="/settings" className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/settings' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <span className="material-symbols-outlined">settings</span>
                                    Settings
                                </Link>
                                <Link to="/time-tracking" className={`flex items-center justify-between px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/time-tracking' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <div className="flex items-center gap-3">
                                        <span className="material-symbols-outlined">schedule</span>
                                        Time Tracking
                                    </div>
                                    <span className={`size-2 rounded-full ${shopStatus === 'open' ? 'bg-green-500' : 'bg-red-500'}`}></span>
                                </Link>
                                <Link to="/notifications" className={`flex items-center justify-between px-3 py-2 rounded-lg transition-colors font-medium text-sm ${activePath === '/notifications' ? 'bg-primary text-white shadow-lg shadow-primary/25' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <div className="flex items-center gap-3">
                                        <span className="material-symbols-outlined">notifications</span>
                                        Alerts
                                    </div>
                                    {unreadCount > 0 && <span className="bg-red-500 text-[10px] font-black px-1.5 py-0.5 rounded-md min-w-[20px] text-center">{unreadCount}</span>}
                                </Link>
                            </div>

                            {/* User Profile */}
                            <div className="p-4 border-t border-white/10 mx-4 mb-4 relative">
                                {userMenuOpen && (
                                    <div className="absolute bottom-full left-0 w-full mb-2 bg-[#1a1d21] rounded-xl shadow-2xl border border-white/10 overflow-hidden animate-slide-up z-[60]">
                                        <button
                                            onClick={() => { navigate('/profile'); setUserMenuOpen(false); }}
                                            className="w-full flex items-center gap-3 px-4 py-3 text-sm font-bold text-gray-300 hover:bg-white/5 hover:text-white transition-colors border-b border-white/5"
                                        >
                                            <span className="material-symbols-outlined text-primary">person</span>
                                            View Profile
                                        </button>
                                        <button
                                            onClick={() => { Store.logout(); window.location.reload(); }}
                                            className="w-full flex items-center gap-3 px-4 py-3 text-sm font-bold text-red-400 hover:bg-red-500/10 transition-colors"
                                        >
                                            <span className="material-symbols-outlined">logout</span>
                                            Exit Terminal
                                        </button>
                                    </div>
                                )}
                                <div
                                    onClick={() => setUserMenuOpen(!userMenuOpen)}
                                    className={`flex items-center gap-3 p-3 rounded-xl transition-all cursor-pointer group ${userMenuOpen ? 'bg-white/10 ring-1 ring-primary/50' : 'bg-white/5 hover:bg-white/10'}`}
                                >
                                    <div className="flex flex-1 items-center gap-3 overflow-hidden">
                                        {user && user.avatar ? (
                                            <div className="size-10 rounded-full border-2 border-primary/50 overflow-hidden shadow-lg bg-gradient-to-br from-gray-800 to-gray-900 shrink-0">
                                                <img src={user.avatar} alt="Avatar" className="w-full h-full object-cover scale-[1.6] relative top-1.5" />
                                            </div>
                                        ) : (
                                            <div className="size-10 rounded-full border-2 border-primary/50 overflow-hidden shadow-lg bg-gradient-to-br from-gray-800 to-gray-900 shrink-0">
                                                <img src="assets/emojis/male/001.png" alt="Avatar" className="w-full h-full object-cover scale-[1.6] relative top-1.5" />
                                            </div>
                                        )}
                                        <div className="flex-1 min-w-0 text-left">
                                            <p className="text-sm font-bold text-white truncate">{user.name}</p>
                                            <p className="text-[10px] text-gray-400 font-black uppercase tracking-widest">{userMenuOpen ? 'Close Menu' : 'Mechanic'}</p>
                                        </div>
                                    </div>
                                    <span className={`material-symbols-outlined text-gray-500 transition-transform duration-300 ${userMenuOpen ? 'rotate-180' : ''}`}>expand_less</span>
                                </div>
                            </div>
                        </aside>
                    )}

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col h-full relative">
                        {/* Header */}
                        {!hideHeader && (
                            <header className="bg-white dark:bg-gray-900 h-20 px-8 flex items-center justify-between border-b border-gray-100 dark:border-gray-800 shrink-0">
                                <div className="flex items-center gap-4">
                                    {!hideNav && (
                                        <button onClick={() => setSidebarOpen(true)} className="lg:hidden p-2 -ml-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400">
                                            <span className="material-symbols-outlined">menu</span>
                                        </button>
                                    )}
                                    {showBack && (
                                        <button onClick={() => navigate(-1)} className="p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400 transition-colors">
                                            <span className="material-symbols-outlined">arrow_back</span>
                                        </button>
                                    )}
                                    <h2 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-400">
                                        {activePath === '/dashboard' ? `Good ${Store.getGreeting()}, ${user?.name?.split(' ')[0] || 'Mechanic'}` :
                                            activePath.replace('/', '').split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
                                    </h2>
                                </div>
                                <div className="flex items-center gap-4">
                                    <DigitalClock className="hidden sm:flex" />
                                    <div className="h-8 w-px bg-gray-200 dark:bg-gray-800 hidden sm:block mx-1"></div>
                                    <button onClick={() => navigate('/notifications')} className="size-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center text-gray-600 dark:text-gray-400 relative transition-colors">
                                        <span className="material-symbols-outlined">notifications</span>
                                        {unreadCount > 0 && <span className="absolute top-2 right-2 size-2 bg-red-500 rounded-full border-2 border-white dark:border-gray-900"></span>}
                                    </button>
                                    <div className="h-8 w-px bg-gray-200 dark:bg-gray-800 mx-1"></div>
                                    <div onClick={() => navigate('/time-tracking')} className="flex flex-col items-end cursor-pointer group">
                                        <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest group-hover:text-primary transition-colors">Shop Status</span>
                                        <span className={`text-sm font-bold flex items-center gap-1.5 ${shopStatus === 'open' ? 'text-green-500' : 'text-red-500'}`}>
                                            <span className={`size-2 rounded-full animate-pulse ${shopStatus === 'open' ? 'bg-green-500' : 'bg-red-500'}`}></span>
                                            {shopStatus === 'open' ? 'Open' : 'Closed'}
                                        </span>
                                    </div>
                                </div>
                            </header>
                        )}

                        {/* Scrollable Area */}
                        <div className="flex-1 overflow-y-auto overflow-x-hidden p-4 pb-24 lg:pb-4 relative scroll-smooth">
                            {children}
                        </div>

                        {/* Mobile Bottom Nav */}
                        {!hideNav && (
                            <nav className="lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 px-6 py-3 flex justify-between items-center z-40 pb-safe">
                                <Link to="/dashboard" className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors ${activePath === '/dashboard' ? 'text-primary' : 'text-gray-400'}`}>
                                    <span className={`material-symbols-outlined ${activePath === '/dashboard' ? 'fill-1' : ''}`}>dashboard</span>
                                    <span className="text-[10px] font-bold">Home</span>
                                </Link>
                                <Link to="/customers" className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors ${activePath === '/customers' ? 'text-primary' : 'text-gray-400'}`}>
                                    <span className={`material-symbols-outlined ${activePath === '/customers' ? 'fill-1' : ''}`}>person</span>
                                    <span className="text-[10px] font-bold">Clients</span>
                                </Link>
                                <Link to="/create-estimate" className="flex flex-col items-center gap-1 -mt-8">
                                    <div className="size-14 bg-primary text-white rounded-full shadow-xl shadow-primary/30 flex items-center justify-center transform active:scale-95 transition-transform">
                                        <span className="material-symbols-outlined text-2xl">add</span>
                                    </div>
                                    <span className="text-[10px] font-bold text-primary mt-1">Estimate</span>
                                </Link>
                                <Link to="/history" className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors ${activePath === '/history' ? 'text-primary' : 'text-gray-400'}`}>
                                    <span className={`material-symbols-outlined ${activePath === '/history' ? 'fill-1' : ''}`}>history</span>
                                    <span className="text-[10px] font-bold">History</span>
                                </Link>
                                <Link to="/settings" className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors ${activePath === '/settings' ? 'text-primary' : 'text-gray-400'}`}>
                                    <span className={`material-symbols-outlined ${activePath === '/settings' ? 'fill-1' : ''}`}>settings</span>
                                    <span className="text-[10px] font-bold">Settings</span>
                                </Link>
                            </nav>
                        )}
                    </div>
                </div>
            );
        };

        const StatusBadge = ({ status }) => {
            const config = {
                pending: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 border-l-4 border-l-amber-500",
                approved: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 border-l-4 border-l-emerald-500",
                sent: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 border-l-4 border-l-blue-500",
                archived: "bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400 border-l-4 border-l-gray-500 line-through opacity-70",
                deleted: "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 border-l-4 border-l-red-500" // Fallback if name varies
            };
            const label = { pending: "Pending", approved: "Approved", sent: "Sent", archived: "Archived", deleted: "Deleted" };
            return (
                <span className={`${config[status] || config.pending} text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider`}>
                    {label[status] || status}
                </span>
            );
        };

        const LoginScreen = () => {
            const navigate = useNavigate();
            const [settings] = useState(Store.getSettings());
            const [loadingExternal, setLoadingExternal] = useState(false);
            const [currentImg, setCurrentImg] = useState(0);

            const images = [
                'https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?q=80&w=2672&auto=format&fit=crop',
                'https://images.unsplash.com/photo-1530046339160-ce3e5b0c7a2f?q=80&w=2670&auto=format&fit=crop',
                'https://images.unsplash.com/photo-1503376780353-7e6692767b70?q=80&w=2670&auto=format&fit=crop'
            ];

            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentImg((prev) => (prev + 1) % images.length);
                }, 6000);
                return () => clearInterval(timer);
            }, []);

            const handleSubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const email = formData.get('email');
                const password = formData.get('password');

                const user = Store.login(email, password);

                if (user) {
                    if (user.role === 'mechanic') {
                        navigate('/dashboard');
                    } else {
                        alert("Customer login detected. Please use the Customer Portal.");
                    }
                } else {
                    alert("Invalid login.");
                }
            };

            return (
                <div className="flex min-h-screen bg-white dark:bg-[#050505]">
                    {loadingExternal && <PageLoader />}

                    {/* Left Side - Hero Slider (Desktop) */}
                    <div className="hidden lg:flex w-1/2 relative overflow-hidden bg-gray-900 border-r border-white/5">
                        {images.map((img, idx) => (
                            <div
                                key={idx}
                                className={`absolute inset-0 transition-all duration-[2000ms] ease-in-out ${idx === currentImg ? 'opacity-100 scale-100' : 'opacity-0 scale-110'}`}
                                style={{
                                    backgroundImage: `url(${img})`,
                                    backgroundSize: 'cover',
                                    backgroundPosition: 'center'
                                }}
                            ></div>
                        ))}
                        <div className="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent z-10"></div>
                        <div className="absolute inset-0 bg-primary/20 mix-blend-overlay z-10"></div>

                        <div className="relative z-20 mt-auto p-16 text-white max-w-2xl">
                            <div className="flex items-center gap-4 mb-8">
                                <div className="size-14 rounded-2xl bg-white/10 backdrop-blur-md border border-white/10 flex items-center justify-center shadow-2xl overflow-hidden">
                                    <img src={settings.businessLogo} className="w-full h-full object-cover scale-[1.5]" />
                                </div>
                                <div className="flex flex-col">
                                    <span className="text-sm font-bold uppercase tracking-[0.2em] text-primary">Operated By</span>
                                    <span className="text-xl font-black tracking-tight">{settings.businessName}</span>
                                </div>
                            </div>
                            <h1 className="text-6xl font-black mb-6 leading-[0.9] tracking-tighter">
                                Workshop<br />Intelligence.
                            </h1>
                            <p className="text-lg text-gray-400 font-medium leading-relaxed max-w-md">
                                The advanced terminal for professional mechanics. Track repairs, manage estimates, and optimize workflow.
                            </p>
                        </div>
                    </div>

                    {/* Right Side - Login Form */}
                    <div className="w-full lg:w-1/2 flex flex-col justify-center items-center px-6 lg:px-20 relative overflow-hidden">

                        {/* Mobile Background Blob */}
                        <div className="lg:hidden absolute top-[-20%] right-[-20%] w-[80%] h-[40%] bg-primary/20 blur-[100px] rounded-full pointer-events-none"></div>

                        <div className="max-w-[400px] w-full relative z-10">

                            {/* Mobile Logo Header */}
                            <div className="lg:hidden flex flex-col items-center mb-10">
                                <div className="size-24 rounded-[2rem] bg-white dark:bg-gray-900 shadow-2xl shadow-primary/20 flex items-center justify-center mb-6 overflow-hidden border-4 border-white dark:border-gray-800 relative group">
                                    <img src={settings.businessLogo} className="w-full h-full object-cover transform transition-transform group-hover:scale-110" />
                                </div>
                                <h2 className="text-lg font-black text-gray-900 dark:text-white uppercase tracking-widest">{settings.businessName}</h2>
                                <span className="px-3 py-1 bg-primary/10 text-primary text-[10px] font-bold uppercase tracking-[0.2em] rounded-full mt-2">Professional Terminal</span>
                            </div>

                            <div className="text-center lg:text-left mb-10">
                                <h1 className="text-4xl lg:text-5xl font-black text-gray-900 dark:text-white tracking-tight mb-3">
                                    Welcome back.
                                </h1>
                                <p className="text-gray-500 dark:text-gray-400 font-medium">Please enter your credentials to access the terminal.</p>
                            </div>

                            <form className="flex flex-col gap-5" onSubmit={handleSubmit}>
                                <div className="group">
                                    <div className="relative">
                                        <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                            <span className="material-symbols-outlined text-gray-400 group-focus-within:text-primary transition-colors">mail</span>
                                        </div>
                                        <input
                                            name="email"
                                            className="w-full h-14 pl-12 pr-4 rounded-xl border border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900/50 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-bold placeholder-gray-400 dark:placeholder-gray-600"
                                            placeholder="Technician Email" // Placeholder instead of label for cleaner look
                                            defaultValue="mechanic@example.com"
                                            type="email"
                                            required
                                        />
                                    </div>
                                </div>

                                <div className="group">
                                    <div className="relative">
                                        <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                            <span className="material-symbols-outlined text-gray-400 group-focus-within:text-primary transition-colors">lock</span>
                                        </div>
                                        <input
                                            name="password"
                                            className="w-full h-14 pl-12 pr-4 rounded-xl border border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900/50 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-bold placeholder-gray-400 dark:placeholder-gray-600"
                                            placeholder="Password"
                                            defaultValue="password"
                                            type="password"
                                            required
                                        />
                                    </div>
                                </div>

                                <div className="flex items-center justify-between text-xs font-bold text-gray-500 mt-1">
                                    <label className="flex items-center gap-2 cursor-pointer hover:text-gray-700 dark:hover:text-gray-300">
                                        <input type="checkbox" className="rounded border-gray-300 text-primary focus:ring-primary" defaultChecked />
                                        Keep me logged in
                                    </label>
                                    <button type="button" className="text-primary hover:underline">Forgot Password?</button>
                                </div>

                                <button className="w-full h-14 bg-gradient-to-r from-gray-900 to-black dark:from-primary dark:to-blue-600 hover:from-black hover:to-gray-900 text-white rounded-xl font-black text-lg shadow-xl shadow-gray-200 dark:shadow-blue-900/40 transition-all hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-3 mt-4">
                                    Access Terminal
                                    <span className="material-symbols-outlined text-xl">arrow_forward</span>
                                </button>
                            </form>
                        </div>

                        {/* Footer Info */}
                        <div className="absolute bottom-6 text-center w-full pb-safe lg:hidden">
                            <p className="text-[10px] text-gray-300 dark:text-gray-600 font-bold uppercase tracking-widest">v2.4.0 &middot; Secure Connection</p>
                        </div>
                    </div>
                </div>
            );
        };




        const DashboardScreen = () => {
            const navigate = useNavigate();
            const [estimates, setEstimates] = useState([]);
            const users = Store.getUsers() || [];

            useEffect(() => {
                try {
                    const allEstimates = Store.getEstimates() || [];
                    setEstimates(allEstimates.filter(e => e && e.status !== 'archived'));
                } catch (e) {
                    console.error("Error loading estimates", e);
                }
            }, []);

            return (
                <Layout>
                    <main className="flex justify-center py-6 px-4 pb-28">
                        <div className="w-full max-w-[600px] flex flex-col gap-6">
                            <div className="flex flex-col gap-1">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-2xl font-bold tracking-tight">Active Estimates</h2>
                                    <span className="bg-primary/10 text-primary text-xs font-bold px-2 py-1 rounded-full">{estimates.length} Total</span>
                                </div>
                                <p className="text-[#617589] text-sm">Review and send these quotes to your customers.</p>
                            </div>

                            {estimates.length === 0 ? (
                                <div className="text-center py-10 bg-white dark:bg-gray-900 rounded-xl border border-dashed border-gray-300 dark:border-gray-700">
                                    <p className="text-gray-500">No active estimates.</p>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-4">
                                    {estimates.map(est => {
                                        if (!est) return null;
                                        return (
                                            <div key={est.id}
                                                onClick={() => navigate(`/review/${est.id}`)}
                                                className={`cursor-pointer bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-[#f0f2f4] dark:border-gray-800 overflow-hidden flex flex-col sm:flex-row transition-all hover:shadow-md hover:scale-[1.01] border-l-4 ${est.status === 'pending' ? 'border-l-amber-500' : est.status === 'approved' ? 'border-l-emerald-500' : 'border-l-blue-500'}`}>
                                                <div className="relative w-full sm:w-32 h-32 sm:h-auto overflow-hidden bg-gray-100 dark:bg-gray-800 shrink-0">
                                                    <img
                                                        src={est.img || 'assets/services/general repair.png'}
                                                        className="w-full h-full object-cover"
                                                        onError={(e) => { e.target.src = 'assets/services/general repair.png'; }}
                                                    />
                                                    {(() => {
                                                        const linkedUser = users.find(u => {
                                                            if (!u) return false;
                                                            const uName = (u.name || "").toLowerCase();
                                                            const eCust = (est.customer || "").toLowerCase();
                                                            const ePhone = Store.normalizePhone(est.phone);
                                                            const uPhone = Store.normalizePhone(u.phone);

                                                            return (est.customerKey && u.shareKey === est.customerKey) ||
                                                                (ePhone && uPhone === ePhone) ||
                                                                (uName && eCust && uName.includes(eCust));
                                                        });
                                                        const avatar = linkedUser ? linkedUser.avatar : 'assets/emojis/male/003.png';
                                                        return (
                                                            <div className="absolute bottom-2 right-2 size-10 rounded-full border-2 border-white shadow-xl overflow-hidden bg-gradient-to-br from-blue-50 to-blue-100 dark:from-gray-800 dark:to-gray-900">
                                                                <img src={avatar} className="w-full h-full object-cover scale-[1.6] relative top-1.5" />
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                                <div className="flex-1 p-4 flex flex-col gap-3">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <StatusBadge status={est.status} />
                                                                <span className="text-[10px] font-medium text-[#617589]">{est.date}</span>
                                                            </div>
                                                            <h3 className="text-lg font-bold text-primary">{est.customer || 'Unnamed Customer'}</h3>
                                                        </div>
                                                        <span className="bg-[#f0f2f4] dark:bg-gray-800 text-xs font-medium px-2 py-1 rounded flex items-center gap-1">
                                                            {est.offline_submission && <span className="material-symbols-outlined text-[10px] text-red-500 animate-pulse">history</span>}
                                                            {est.id}
                                                        </span>
                                                    </div>
                                                    <div className="flex flex-col gap-1">
                                                        <div className="flex items-center gap-2 text-sm text-[#111418] dark:text-gray-300">
                                                            <span className="material-symbols-outlined text-base">directions_car</span>
                                                            <span>{est.vehicle || 'Unknown Vehicle'}</span>
                                                        </div>
                                                        <div className="flex items-center gap-2 text-sm text-[#617589]">
                                                            <span className="material-symbols-outlined text-base">build</span>
                                                            <span>{est.service || 'General Service'}</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between pt-2 border-t border-[#f0f2f4] dark:border-gray-800">
                                                        <p className="text-lg font-bold">{Store.getSettings().currencySymbol}{Number(est.amount || 0).toFixed(2)}</p>
                                                        <button
                                                            className="bg-primary text-white text-sm font-semibold px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors active:scale-95">
                                                            {est.status === 'pending' ? 'Review & Price' : est.status === 'approved' ? 'View/Send' : 'View Invoice'}
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            <button onClick={() => navigate('/create-estimate')} className="flex items-center justify-center gap-2 w-full py-4 border-2 border-dashed border-primary/30 rounded-xl text-primary font-bold hover:bg-primary/5 transition-colors">
                                <span className="material-symbols-outlined">add_circle</span>
                                <span>Create New Estimate (Manual)</span>
                            </button>
                        </div>
                    </main>
                </Layout>
            );
        };

        const CreateEstimateScreen = () => {
            const navigate = useNavigate();

            const handleSubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const newEst = Store.createEstimate({
                    customer: formData.get('customer'),
                    phone: formData.get('phone'),
                    vehicle: formData.get('vehicle'),
                    service: formData.get('service'),
                    customerKey: formData.get('customerKey') ? formData.get('customerKey').trim().toUpperCase() : null,
                    notes: 'Created manually by mechanic'
                });
                navigate('/review/' + newEst.id);
            };

            return (
                <Layout>
                    <div className="flex justify-center py-6 px-4 pb-20">
                        <div className="w-full max-w-[600px] flex flex-col gap-6">
                            <div className="flex flex-col gap-2 mb-4">
                                <Link to="/dashboard" className="flex items-center gap-2 text-primary mb-2 text-sm font-semibold uppercase tracking-wider">
                                    <span className="material-symbols-outlined text-sm">arrow_back</span> Back to Dashboard
                                </Link>
                                <h1 className="text-3xl font-black tracking-tight">Create Estimate</h1>
                                <p className="text-[#617589] dark:text-gray-400">Fill in the details to start a new estimate for a client.</p>
                            </div>

                            <form className="flex flex-col gap-6 bg-white dark:bg-gray-900 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800" onSubmit={handleSubmit}>

                                <div className="p-4 bg-primary/5 rounded-xl border border-primary/10">
                                    <div className="flex flex-col gap-2">
                                        <label className="font-semibold dark:text-gray-200 text-sm flex items-center gap-2">
                                            <span className="material-symbols-outlined text-primary">link</span>
                                            Customer Link Key (Optional)
                                        </label>
                                        <div className="flex gap-2">
                                            <input name="customerKey" className="form-input flex-1 rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-12 px-4 font-mono text-sm uppercase tracking-wider" placeholder="e.g. C-XXXX" />
                                        </div>
                                        <p className="text-xs text-gray-500">Enter the customer's unique key (found on their dashboard) to link this estimate directly.</p>
                                    </div>
                                </div>

                                <div className="flex flex-col gap-2">
                                    <label className="font-semibold dark:text-gray-200">Full Name</label>
                                    <input name="customer" className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-14 px-4" placeholder="Client Name" required />
                                </div>
                                <div className="flex flex-col gap-2">
                                    <label className="font-semibold dark:text-gray-200">Phone Number</label>
                                    <input name="phone" className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-14 px-4" placeholder="(555) 000-0000" type="tel" required />
                                </div>
                                <div className="flex flex-col gap-2">
                                    <label className="font-semibold dark:text-gray-200">Vehicle Details</label>
                                    <input name="vehicle" className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-14 px-4" placeholder="e.g. 2018 Toyota Camry" required />
                                </div>
                                <div className="flex flex-col gap-2">
                                    <label className="font-semibold dark:text-gray-200">Service Needed</label>
                                    <select name="service" className="form-select rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-14 px-4" required>
                                        <option value="">Select a service</option>
                                        <option value="Oil Change">Oil Change</option>
                                        <option value="Brake Repair">Brake Repair</option>
                                        <option value="Engine Diagnostic">Engine Diagnostic</option>
                                        <option value="General Repair">General Repair</option>
                                    </select>
                                </div>
                                <button className="w-full bg-primary hover:bg-primary/90 text-white font-bold text-lg py-5 rounded-xl shadow-lg mt-4 transition-all" type="submit">
                                    Continue to Costing
                                </button>
                            </form>
                        </div>
                    </div>
                </Layout>
            );
        };

        const ReviewScreen = () => {
            const navigate = useNavigate();
            const { id } = useParams();
            const [estimate, setEstimate] = useState(null);

            // Editable fields
            const [labor, setLabor] = useState(0);
            const [parts, setParts] = useState(0);
            const [taxRate, setTaxRate] = useState(8.25);

            useEffect(() => {
                const est = Store.getEstimate(id);
                if (!est) return navigate('/dashboard');
                setEstimate(est);
                setLabor(est.laborCost);
                setParts(est.partsCost);
            }, [id]);

            const subtotal = useMemo(() => Number(labor) + Number(parts), [labor, parts]);
            const taxAmount = useMemo(() => (subtotal * taxRate) / 100, [subtotal, taxRate]);
            const total = useMemo(() => subtotal + taxAmount, [subtotal, taxAmount]);

            const handleSave = (status) => {
                const updated = Object.assign({}, estimate, {
                    laborCost: Number(labor),
                    partsCost: Number(parts),
                    tax: taxAmount,
                    amount: total,
                    status: status
                });
                Store.saveEstimate(updated);
                setEstimate(updated);

                if (status === 'approved') {
                    navigate('/processing/' + id);
                } else {
                    alert('Draft Saved');
                }
            };

            const handleDelete = () => {
                if (window.confirm('Are you sure you want to archive this request? It will be moved to history as deleted.')) {
                    Store.deleteEstimate(id);
                    navigate('/dashboard');
                }
            };

            if (!estimate) return <Layout><div className="text-center p-10">Loading...</div></Layout>;

            return (
                <Layout>
                    <div className="flex flex-1 justify-center py-8 px-4 md:px-0 mb-20 animate-[fadeIn_0.3s_ease-out]">
                        <div className="flex flex-col max-w-[800px] flex-1">
                            <div className="flex flex-wrap gap-2 pb-4">
                                <Link className="text-[#617589] text-sm font-medium hover:underline flex items-center gap-1" to="/dashboard">
                                    <span className="material-symbols-outlined text-sm">arrow_back</span>Estimates
                                </Link>
                                <span className="text-[#617589] text-sm font-medium">/</span>
                                <span className="text-[#111418] dark:text-gray-400 text-sm font-medium">{estimate.id}</span>
                            </div>
                            <div className="flex flex-wrap justify-between items-end gap-3 pb-6">
                                <div className="flex min-w-72 flex-col gap-1">
                                    <h1 className="text-3xl font-black tracking-tight">{estimate.status === 'pending' ? 'Review & Costing' : 'Estimate Details'}</h1>
                                    <p className="text-[#617589] dark:text-gray-400 text-base">Finalize the numbers and approve for sending to client</p>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={handleDelete} className="flex min-w-[40px] items-center justify-center rounded-lg h-10 px-3 bg-red-50 text-red-500 hover:bg-red-100 transition-colors" title="Archive Request">
                                        <span className="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                    <button onClick={() => handleSave('pending')} className="flex min-w-[100px] items-center justify-center rounded-lg h-10 px-4 bg-gray-100 dark:bg-gray-800 text-[#111418] dark:text-white text-sm font-bold hover:bg-gray-200 transition-colors">
                                        <span>Save Draft</span>
                                    </button>
                                </div>
                            </div>

                            <div className="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-4 mb-6 shadow-sm">
                                <div className="flex flex-col md:flex-row gap-6">
                                    <div className="w-full md:w-48 aspect-video overflow-hidden rounded-lg border border-gray-100 dark:border-gray-700 bg-gray-100 dark:bg-gray-800">
                                        <img
                                            src={estimate.img || 'assets/services/general repair.png'}
                                            className="w-full h-full object-cover"
                                            onError={(e) => { e.target.src = 'assets/services/general repair.png'; }}
                                        />
                                    </div>
                                    <div className="flex flex-1 flex-col justify-center gap-1">
                                        <div className="flex items-center gap-4">
                                            <div className="size-12 rounded-full border-2 border-primary/20 overflow-hidden bg-gradient-to-br from-blue-50 to-blue-100 dark:from-gray-800 dark:to-gray-900 shadow-sm">
                                                {(() => {
                                                    const users = Store.getUsers();
                                                    const linkedUser = users.find(u => {
                                                        const uName = (u?.name || "").toLowerCase();
                                                        const estCust = (estimate?.customer || "").toLowerCase();
                                                        return (estimate?.customerKey && u?.shareKey === estimate.customerKey) ||
                                                            (estimate?.phone && Store.normalizePhone(u?.phone) === Store.normalizePhone(estimate.phone)) ||
                                                            (uName && estCust && uName.includes(estCust));
                                                    });
                                                    const avatar = linkedUser ? linkedUser.avatar : 'assets/emojis/male/004.png';
                                                    return <img src={avatar} className="w-full h-full object-cover scale-[1.6] relative top-2" />;
                                                })()}
                                            </div>
                                            <p className="text-xl font-bold">{estimate.customer}</p>
                                        </div>
                                        <div className="flex items-center gap-2 text-primary font-medium text-sm">
                                            <span className="material-symbols-outlined text-sm">call</span>
                                            <p>{estimate.phone}</p>
                                        </div>
                                        <div className="flex flex-wrap gap-x-4 gap-y-1 mt-2">
                                            <div className="flex items-center gap-1">
                                                <span className="material-symbols-outlined text-gray-400 text-sm">directions_car</span>
                                                <p className="text-[#617589] dark:text-gray-400 text-sm">{estimate.vehicle}</p>
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <span className="material-symbols-outlined text-gray-400 text-sm">assignment</span>
                                                <p className="text-[#617589] dark:text-gray-400 text-sm">{estimate.service}</p>
                                            </div>
                                        </div>
                                        {estimate.notes && (
                                            <div className="mt-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg text-sm text-gray-600 dark:text-gray-300 italic border-l-2 border-primary">
                                                "{estimate.notes}"
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden shadow-sm">
                                <h2 className="text-[20px] font-bold px-6 py-5 border-b border-gray-100 dark:border-gray-800">Costing Details</h2>
                                <div className="p-6 space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="flex flex-col gap-2">
                                            <label className="text-sm font-bold">Labor Cost</label>
                                            <div className="relative">
                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">{Store.getSettings().currencySymbol}</span>
                                                <input
                                                    className="w-full rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-800 pl-8 pr-4 py-2 focus:ring-primary focus:border-primary"
                                                    value={labor}
                                                    onChange={(e) => setLabor(e.target.value)}
                                                    type="number"
                                                />
                                            </div>
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <label className="text-sm font-bold">Parts Cost</label>
                                            <div className="relative">
                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">{Store.getSettings().currencySymbol}</span>
                                                <input
                                                    className="w-full rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-800 pl-8 pr-4 py-2 focus:ring-primary focus:border-primary"
                                                    value={parts}
                                                    onChange={(e) => setParts(e.target.value)}
                                                    type="number"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-primary/5 dark:bg-primary/10 rounded-xl p-6 border border-primary/20">
                                        <div className="space-y-3">
                                            <div className="flex justify-between text-sm">
                                                <span className="text-[#617589]">Subtotal</span>
                                                <span className="font-medium">{Store.getSettings().currencySymbol}{Number(subtotal).toFixed(2)}</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-[#617589]">Tax ({Store.getSettings().taxRate}%)</span>
                                                <span className="font-medium">{Store.getSettings().currencySymbol}{Number(taxAmount).toFixed(2)}</span>
                                            </div>
                                            <div className="pt-3 border-t border-primary/20 flex justify-between items-center">
                                                <span className="text-lg font-bold">Grand Total</span>
                                                <span className="text-primary text-2xl font-black">{Store.getSettings().currencySymbol}{Number(total).toFixed(2)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => handleSave('approved')}
                                        className="w-full h-12 flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-white rounded-lg font-bold transition-all shadow-md active:scale-95">
                                        <span className="material-symbols-outlined">send</span> {estimate.status === 'sent' ? 'Resend Invoice' : 'Confirm & Send'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </Layout>
            );
        };



        const InvoiceScreen = () => {
            const navigate = useNavigate();
            const { id } = useParams();
            const estimate = Store.getEstimate(id);

            if (!estimate) return <div className="p-10 text-center">Estimate Not Found</div>;

            const handleMarkPaid = () => {
                Store.markPaid(id);
                navigate('/success');
            };

            const handleEmail = () => {
                navigate(`/processing/${id}`);
            };

            return (
                <Layout>
                    <header className="no-print sticky top-0 z-50 w-full bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 py-3">
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            <button onClick={() => navigate('/dashboard')} className="flex items-center gap-2 text-slate-600 dark:text-slate-400 hover:text-primary">
                                <span className="material-symbols-outlined">arrow_back</span>
                                <span className="text-sm font-medium">Back</span>
                            </button>
                            <div className="flex items-center gap-2 md:gap-3">
                                <button className="flex items-center gap-2 px-4 py-2 text-sm font-semibold border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800" onClick={() => window.print()}>
                                    <span className="material-symbols-outlined text-lg">print</span><span className="hidden sm:inline">Print</span>
                                </button>
                                <button onClick={handleEmail} className="flex items-center gap-2 px-4 py-2 text-sm font-semibold bg-gray-900 dark:bg-white dark:text-gray-900 text-white rounded-lg hover:opacity-90">
                                    <span className="material-symbols-outlined text-lg">mail</span><span>Email</span>
                                </button>
                                <button className="flex items-center gap-2 px-4 py-2 text-sm font-semibold bg-primary text-white rounded-lg hover:bg-primary/90" onClick={handleMarkPaid}>
                                    <span className="material-symbols-outlined text-lg">check_circle</span><span className="hidden sm:inline">Mark Paid</span>
                                </button>
                            </div>
                        </div>
                    </header>
                    <div className="flex flex-col items-center py-8 px-4 print-m-0 pb-32">
                        <div className="w-full max-w-4xl bg-white dark:bg-slate-900 rounded-xl shadow-xl border border-slate-200 dark:border-slate-800 overflow-hidden print-shadow-none print-border">
                            <div className="p-8 md:p-12 border-b border-slate-100 dark:border-slate-800">
                                <div className="flex flex-col md:flex-row justify-between gap-8">
                                    <div>
                                        <div className="flex items-center gap-3 mb-4">
                                            <div className="size-10 bg-primary/10 rounded-lg flex items-center justify-center overflow-hidden border border-primary/20">
                                                <img src={Store.getSettings().businessLogo || "assets/emojis/male/008.png"} className="w-full h-full object-cover scale-[1.8] relative top-2.5" />
                                            </div>
                                            <h1 className="text-xl font-black uppercase tracking-tight">{Store.getSettings().businessName}</h1>
                                        </div>
                                        <div className="text-sm text-slate-500 dark:text-slate-400 space-y-1">
                                            <p>{Store.getSettings().businessAddress}</p>
                                            <p>{Store.getSettings().businessPhone}</p>
                                        </div>
                                    </div>
                                    <div className="flex flex-col md:items-end gap-3">
                                        <div className="flex items-center gap-3">
                                            {estimate.paid && (
                                                <div className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 px-3 py-1 rounded-md text-xs font-bold uppercase tracking-wider flex items-center gap-1.5 border border-emerald-200 dark:border-emerald-800">
                                                    <span className="size-2 rounded-full bg-emerald-500"></span> Paid
                                                </div>
                                            )}
                                            <span className="text-2xl font-black text-slate-900 dark:text-white">#{estimate.id}</span>
                                        </div>
                                        <div className="text-sm text-slate-500 dark:text-slate-400 space-y-1 md:text-right">
                                            <p>Invoice Date: <span className="text-slate-900 dark:text-white font-semibold">{estimate.date}</span></p>
                                            <p>Status: <span className="capitalize">{estimate.status}</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-800">
                                <div className="p-8 md:p-12 border-b md:border-b-0 md:border-r border-slate-100 dark:border-slate-800">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Bill To</h3>
                                    <p className="text-lg font-bold">{estimate.customer}</p>
                                    <p className="text-sm text-slate-500">{estimate.phone}</p>
                                </div>
                                <div className="p-8 md:p-12">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Vehicle Details</h3>
                                    <div className="grid grid-cols-2 gap-y-2 text-sm">
                                        <span className="text-slate-500 font-medium">Make/Model:</span>
                                        <span className="font-bold">{estimate.vehicle}</span>
                                        <span className="text-slate-500 font-medium">Service:</span>
                                        <span className="font-bold">{estimate.service}</span>
                                    </div>
                                </div>
                            </div>
                            <div className="p-8 md:p-12">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="text-slate-400 text-xs font-bold uppercase border-b border-slate-200 dark:border-slate-700">
                                            <th className="pb-4">Service / Parts</th>
                                            <th className="pb-4 text-center">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 dark:divide-slate-800">
                                        <tr>
                                            <td className="py-6"><p className="font-bold">Labor Charges</p></td>
                                            <td className="py-6 text-right font-bold">{Store.getSettings().currencySymbol}{Number(estimate.laborCost).toFixed(2)}</td>
                                        </tr>
                                        <tr>
                                            <td className="py-6"><p className="font-bold">Parts & Materials</p></td>
                                            <td className="py-6 text-right font-bold">{Store.getSettings().currencySymbol}{Number(estimate.partsCost).toFixed(2)}</td>
                                        </tr>
                                        {Number(estimate.tax) > 0 && (
                                            <tr>
                                                <td className="py-6"><p className="font-bold text-slate-500">Tax</p></td>
                                                <td className="py-6 text-right font-bold text-slate-500">{Store.getSettings().currencySymbol}{Number(estimate.tax).toFixed(2)}</td>
                                            </tr>
                                        )}
                                        <tr className="text-xl">
                                            <td className="pt-6 font-black text-right pr-10">Total</td>
                                            <td className="pt-6 text-right font-black text-primary">{Store.getSettings().currencySymbol}{Number(estimate.amount).toFixed(2)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                {estimate.notes && (
                                    <div className="mt-8 p-4 bg-yellow-50 dark:bg-yellow-900/10 text-yellow-800 dark:text-yellow-200 rounded-lg text-sm">
                                        <strong>Mechanic Notes:</strong> {estimate.notes}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </Layout>
            );
        };

        const SuccessScreen = () => {
            const navigate = useNavigate();
            return (
                <Layout hideNav>
                    <div className="flex-1 flex items-center justify-center py-10 px-4 animate-[fadeIn_0.5s_ease-out]">
                        <div className="max-w-[520px] w-full bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-8 flex flex-col items-center">
                            <div className="bg-primary/10 p-6 rounded-full mb-6">
                                <span className="material-symbols-outlined text-primary !text-7xl font-light">check_circle</span>
                            </div>
                            <h1 className="text-3xl font-bold tracking-tight text-center">Success!</h1>
                            <p className="text-gray-600 dark:text-gray-400 text-center mt-3">The action was completed successfully.</p>
                            <button onClick={() => navigate('/dashboard')} className="w-full bg-primary text-white font-semibold py-4 rounded-lg mt-8 flex items-center justify-center gap-2 hover:bg-primary/90 transition-colors">
                                <span className="material-symbols-outlined">home</span> Back to Dashboard
                            </button>
                        </div>
                    </div>
                </Layout>
            );
        };

        const ProcessingScreen = () => {
            const { id } = useParams();
            const navigate = useNavigate();
            const [status, setStatus] = useState('init'); // init, processing, success, error
            const [progress, setProgress] = useState(0);

            useEffect(() => {
                const processEmail = async () => {
                    setStatus('processing');
                    const est = Store.getEstimate(id);
                    if (!est) {
                        setStatus('error');
                        return;
                    }

                    // 1. Queue Email
                    Store.queueEmail(est.id, 'customer@example.com'); // In real app, use est.email

                    // 2. Simulate Cloud Processing
                    const steps = [10, 30, 60, 80, 100];
                    for (const p of steps) {
                        setProgress(p);
                        await new Promise(r => setTimeout(r, 600)); // Simulate network lag
                    }

                    // 3. Mark as Sent
                    if (est.status !== 'sent') {
                        const updated = Object.assign({}, est, { status: 'sent' });
                        Store.saveEstimate(updated);
                    }

                    setStatus('success');
                };

                processEmail();
            }, [id]);

            return (
                <Layout hideNav>
                    <div className="flex-1 flex flex-col items-center justify-center p-6 animate-fade-in">
                        <div className="max-w-md w-full bg-white dark:bg-gray-900 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-800 overflow-hidden relative">

                            {/* Header Gradient */}
                            <div className="h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500 animate-gradient-x"></div>

                            <div className="p-10 flex flex-col items-center text-center">

                                {status === 'processing' && (
                                    <>
                                        <div className="size-20 bg-blue-50 dark:bg-blue-900/20 rounded-full flex items-center justify-center mb-6 relative">
                                            <span className="material-symbols-outlined text-4xl text-blue-500 animate-pulse">mail</span>
                                            <svg className="absolute inset-0 size-full rotate-[-90deg]" viewBox="0 0 36 36">
                                                <path className="text-blue-100 dark:text-blue-900/30" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="2" />
                                                <path className="text-blue-500 transition-all duration-300 ease-linear" strokeDasharray={`${progress}, 100`} d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="2" />
                                            </svg>
                                        </div>
                                        <h2 className="text-xl font-bold mb-2">Sending Invoice #{id}</h2>
                                        <p className="text-gray-500 text-sm">Processing secure delivery...</p>
                                    </>
                                )}

                                {status === 'success' && (
                                    <div className="animate-scale-in flex flex-col items-center">
                                        <div className="size-20 bg-green-50 dark:bg-green-900/20 rounded-full flex items-center justify-center mb-6 text-green-500">
                                            <span className="material-symbols-outlined text-4xl">check_circle</span>
                                        </div>
                                        <h2 className="text-xl font-bold mb-2">Email Sent Successfully</h2>
                                        <p className="text-gray-500 text-sm mb-8">The invoice has been queued for delivery.</p>

                                        <div className="flex flex-col w-full gap-3">
                                            <button onClick={() => navigate('/dashboard')} className="w-full py-3 bg-gray-900 dark:bg-gray-700 text-white rounded-xl font-bold hover:scale-[1.02] transition-transform">
                                                Back to Dashboard
                                            </button>
                                            <button onClick={() => navigate(`/invoice/${id}`)} className="w-full py-3 text-gray-600 dark:text-gray-400 font-bold hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl transition-colors">
                                                View Invoice
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {status === 'error' && (
                                    <div className="flex flex-col items-center">
                                        <div className="size-20 bg-red-50 dark:bg-red-900/20 rounded-full flex items-center justify-center mb-6 text-red-500">
                                            <span className="material-symbols-outlined text-4xl">error</span>
                                        </div>
                                        <h2 className="text-xl font-bold mb-2">Delivery Failed</h2>
                                        <p className="text-gray-500 text-sm mb-8">Could not find estimate parameters.</p>
                                        <button onClick={() => navigate('/dashboard')} className="w-full py-3 bg-gray-900 text-white rounded-xl font-bold">
                                            Return Home
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </Layout>
            );
        };

        const SettingsScreen = () => {
            const navigate = useNavigate();
            const [settings, setSettings] = useState(Store.getSettings());
            const [logoPreview, setLogoPreview] = useState(settings.businessLogo);

            const CURRENCIES = [
                { symbol: '$', code: 'USD', name: 'US Dollar' },
                { symbol: '', code: 'EUR', name: 'Euro' },
                { symbol: '', code: 'GBP', name: 'British Pound' },
                { symbol: '', code: 'JPY', name: 'Japanese Yen' },
                { symbol: 'A$', code: 'AUD', name: 'Australian Dollar' },
                { symbol: 'C$', code: 'CAD', name: 'Canadian Dollar' },
                { symbol: 'CHF', code: 'CHF', name: 'Swiss Franc' },
                { symbol: '', code: 'CNY', name: 'Chinese Yuan' },
                { symbol: 'kr', code: 'SEK', name: 'Swedish Krona' },
                { symbol: 'NZ$', code: 'NZD', name: 'NZ Dollar' },
                { symbol: '', code: 'INR', name: 'Indian Rupee' },
                { symbol: 'R$', code: 'BRL', name: 'Brazilian Real' },
                { symbol: '', code: 'RUB', name: 'Russian Ruble' },
                { symbol: 'R', code: 'ZAR', name: 'South African Rand' },
                { symbol: '', code: 'TRY', name: 'Turkish Lira' },
            ];

            const [swapping, setSwapping] = useState(false);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setLogoPreview(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleSave = async (e) => {
                e.preventDefault();
                setSwapping(true);
                const formData = new FormData(e.target);
                const newCurrencyCode = formData.get('currencyCode');
                const currency = CURRENCIES.find(c => c.code === newCurrencyCode);

                // Handle Currency Conversion if changed
                if (newCurrencyCode !== settings.currencyCode) {
                    const success = await Store.applyCurrencySwap(settings.currencyCode, newCurrencyCode);
                    if (!success) {
                        alert(`Warning: Could not fetch real-time rates for ${newCurrencyCode}. Prices remain unchanged, but the symbol will update.`);
                    }
                }

                const updated = {
                    businessName: formData.get('businessName'),
                    businessPhone: formData.get('businessPhone'),
                    businessAddress: formData.get('businessAddress'),
                    currencySymbol: currency.symbol,
                    currencyCode: currency.code,
                    taxRate: parseFloat(formData.get('taxRate')),
                    footerText: formData.get('footerText'),
                    businessLogo: logoPreview
                };

                Store.saveSettings(updated);
                setSwapping(false);
                alert('Workshop Settings & Currency Sync Updated Successfully!');
                navigate('/dashboard');
            };

            return (
                <Layout>
                    <main className="flex flex-1 justify-center py-10 px-4 md:px-0">
                        <div className="layout-content-container flex flex-col max-w-[640px] flex-1 bg-white dark:bg-gray-900/50 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-6 md:p-10 mb-20 animate-[slideIn_0.3s_ease-out]">
                            <div className="flex flex-col gap-2 mb-8 border-b border-gray-100 dark:border-gray-800 pb-6">
                                <Link to="/dashboard" className="flex items-center gap-2 text-primary mb-2 text-sm font-semibold uppercase tracking-wider">
                                    <span className="material-symbols-outlined text-sm">arrow_back</span> Back to Dashboard
                                </Link>
                                <h1 className="text-3xl font-black tracking-tight">Business Settings</h1>
                                <p className="text-[#617589] dark:text-gray-400">Manage your professional details and invoice preferences.</p>
                            </div>
                            <form className="flex flex-col gap-8" onSubmit={handleSave}>
                                <section>
                                    <h3 className="text-lg font-bold mb-6 flex items-center gap-2 text-primary border-b dark:border-gray-800 pb-2">
                                        <span className="material-symbols-outlined">branding_watermark</span> Brand Identity
                                    </h3>
                                    <div className="flex items-center gap-6 mb-6">
                                        <div className="size-24 rounded-2xl bg-gray-50 dark:bg-gray-800 border-2 border-dashed border-gray-200 dark:border-gray-700 flex items-center justify-center overflow-hidden relative group">
                                            {logoPreview ? (
                                                <img src={logoPreview} className="w-full h-full object-cover" />
                                            ) : (
                                                <span className="material-symbols-outlined text-gray-300 text-3xl">image</span>
                                            )}
                                            <label className="absolute inset-0 bg-black/50 text-white opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center cursor-pointer text-[10px] font-bold">
                                                <span className="material-symbols-outlined text-sm mb-1">upload</span>
                                                CHANGE LOGO
                                                <input type="file" className="hidden" accept="image/*" onChange={handleFileChange} />
                                            </label>
                                        </div>
                                        <div className="flex-1">
                                            <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Business Logo</p>
                                            <p className="text-xs text-gray-500">This logo will appear on all PDF invoices and customer communications. PNG or JPG recommended.</p>
                                        </div>
                                    </div>

                                    <div className="flex flex-col gap-4">
                                        <div className="flex flex-col gap-2">
                                            <label className="text-sm font-semibold">Business Name</label>
                                            <input name="businessName" className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-12 px-4 font-bold" defaultValue={settings.businessName} type="text" required />
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="flex flex-col gap-2">
                                                <label className="text-sm font-semibold">Phone Number</label>
                                                <input name="businessPhone" className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-12 px-4 font-bold" defaultValue={settings.businessPhone} type="tel" required />
                                            </div>
                                            <div className="flex flex-col gap-2">
                                                <label className="text-sm font-semibold">Default Tax Rate (%)</label>
                                                <input name="taxRate" className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-12 px-4 font-bold" defaultValue={settings.taxRate} type="number" step="0.01" required />
                                            </div>
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <label className="text-sm font-semibold">Business Address</label>
                                            <input name="businessAddress" className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-12 px-4 font-bold" defaultValue={settings.businessAddress} type="text" required />
                                        </div>
                                    </div>
                                </section>

                                <section>
                                    <h3 className="text-lg font-bold mb-6 flex items-center gap-2 text-primary border-b dark:border-gray-800 pb-2">
                                        <span className="material-symbols-outlined">payments</span> Currency & Finance
                                    </h3>
                                    <div className="flex flex-col gap-2">
                                        <label className="text-sm font-semibold">Workshop Currency</label>
                                        <select name="currencyCode" className="form-select rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-12 px-4 font-bold" defaultValue={settings.currencyCode}>
                                            {CURRENCIES.map(c => (
                                                <option key={c.code} value={c.code}>{c.name} ({c.symbol})</option>
                                            ))}
                                        </select>
                                    </div>
                                </section>

                                <section>
                                    <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-primary border-b dark:border-gray-800 pb-2">
                                        <span className="material-symbols-outlined">receipt_long</span> Invoice Footer
                                    </h3>
                                    <div className="flex flex-col gap-2">
                                        <label className="text-sm font-semibold">Terms & Conditions</label>
                                        <textarea name="footerText" className="form-input rounded-lg dark:bg-gray-800 border-gray-300 dark:border-gray-700 min-h-24 p-4 font-medium" defaultValue={settings.footerText} />
                                    </div>
                                </section>

                                <div className="flex items-center justify-end gap-4 pt-6 border-t border-gray-100 dark:border-gray-800">
                                    <button type="button" onClick={() => navigate('/dashboard')} className="px-6 py-3 rounded-lg text-sm font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800">Discard</button>
                                    <button
                                        className={`bg-primary text-white px-10 py-3 rounded-lg text-sm font-black shadow-lg shadow-primary/20 hover:bg-primary/90 transition-all active:scale-95 flex items-center gap-3 ${swapping ? 'opacity-70 pointer-events-none' : ''}`}
                                        type="submit"
                                    >
                                        {swapping ? (
                                            <>
                                                <span className="material-symbols-outlined animate-spin text-sm">sync</span>
                                                Syncing Rates...
                                            </>
                                        ) : (
                                            'Save Workshop Profile'
                                        )}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </main>
                </Layout>
            );
        };

        const OfflineErrorScreen = () => {
            const navigate = useNavigate();
            return (
                <Layout hideNav>
                    <main className="flex-grow flex items-center justify-center p-6 min-h-screen">
                        <div className="w-full max-w-[480px] bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-8">
                            <div className="flex flex-col items-center text-center gap-8">
                                <div className="relative flex items-center justify-center w-full aspect-video bg-red-50 dark:bg-red-900/10 rounded-xl overflow-hidden">
                                    <div className="flex flex-col items-center">
                                        <span className="material-symbols-outlined text-red-500 text-7xl mb-2">wifi_off</span>
                                    </div>
                                </div>
                                <div className="flex flex-col gap-3">
                                    <h1 className="text-[#111418] dark:text-white text-2xl font-bold tracking-tight">Manual Mode</h1>
                                    <p className="text-gray-600 dark:text-gray-400 text-base leading-relaxed">
                                        Since this is a demo, you can't create an estimate here. Go to the Customer View to submit a new request.
                                    </p>
                                </div>
                                <div className="flex flex-col w-full gap-4">
                                    <button onClick={() => navigate('/request')} className="flex w-full items-center justify-center rounded-lg h-12 bg-primary text-white font-bold hover:bg-primary/90">
                                        Go to Customer Form
                                    </button>
                                    <button onClick={() => navigate('/dashboard')} className="flex w-full items-center justify-center rounded-lg h-12 bg-gray-100 dark:bg-gray-800 text-[#111418] dark:text-white text-sm font-semibold">
                                        Back to Dashboard
                                    </button>
                                </div>
                            </div>
                        </div>
                    </main>
                </Layout>
            );
        };

        const TimeTrackingScreen = () => {
            const [shopStatus, setShopStatus] = useState(Store.getShopStatus());
            const [history, setHistory] = useState([
                { id: 1, action: 'Terminated Session', time: '8:45 PM', date: 'Jan 17, 2026', status: 'closed' },
                { id: 2, action: 'Initialized Shop', time: '9:15 AM', date: 'Jan 17, 2026', status: 'open' },
                { id: 3, action: 'System Sync', time: '12:30 PM', date: 'Jan 17, 2026', status: 'open' },
            ]);

            const toggleStatus = (newStatus) => {
                Store.setShopStatus(newStatus);
                setShopStatus(newStatus);
                const newEntry = {
                    id: Date.now(),
                    action: newStatus === 'open' ? 'Workshop Entrance Enabled' : 'Workshop Entrance Disabled',
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    date: new Date().toLocaleDateString([], { month: 'short', day: '2-digit', year: 'numeric' }),
                    status: newStatus
                };
                setHistory([newEntry, ...history]);
            };

            return (
                <Layout>
                    <main className="flex justify-center py-8 px-4 pb-28">
                        <div className="w-full max-w-[600px] flex flex-col gap-8">
                            <div className="flex flex-col gap-2">
                                <h2 className="text-3xl font-black tracking-tight dark:text-white uppercase">Workshop Terminal Control</h2>
                                <p className="text-gray-500 text-xs font-bold uppercase tracking-[0.2em]">Manage shop availability and terminal presence</p>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div
                                    onClick={() => toggleStatus('open')}
                                    className={`cursor-pointer p-8 rounded-[2.5rem] border-2 transition-all flex flex-col items-center gap-4 ${shopStatus === 'open' ? 'bg-green-600/10 border-green-500 shadow-xl shadow-green-500/10' : 'bg-white dark:bg-gray-900 border-gray-100 dark:border-gray-800 opacity-60 hover:opacity-100'}`}
                                >
                                    <div className={`size-16 rounded-2xl flex items-center justify-center shadow-lg ${shopStatus === 'open' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-400 dark:bg-gray-800'}`}>
                                        <span className="material-symbols-outlined text-3xl">power_settings_new</span>
                                    </div>
                                    <div className="text-center">
                                        <h3 className="text-xl font-black dark:text-white">ONLINE</h3>
                                        <p className="text-[10px] font-bold text-gray-500 uppercase tracking-widest mt-1">Accepting Estimates</p>
                                    </div>
                                    {shopStatus === 'open' && <div className="mt-2 size-2 bg-green-500 rounded-full animate-ping"></div>}
                                </div>

                                <div
                                    onClick={() => toggleStatus('closed')}
                                    className={`cursor-pointer p-8 rounded-[2.5rem] border-2 transition-all flex flex-col items-center gap-4 ${shopStatus === 'closed' ? 'bg-red-600/10 border-red-500 shadow-xl shadow-red-500/10' : 'bg-white dark:bg-gray-900 border-gray-100 dark:border-gray-800 opacity-60 hover:opacity-100'}`}
                                >
                                    <div className={`size-16 rounded-2xl flex items-center justify-center shadow-lg ${shopStatus === 'closed' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-400 dark:bg-gray-800'}`}>
                                        <span className="material-symbols-outlined text-3xl">block</span>
                                    </div>
                                    <div className="text-center">
                                        <h3 className="text-xl font-black dark:text-white">OFFLINE</h3>
                                        <p className="text-[10px] font-bold text-gray-500 uppercase tracking-widest mt-1">Workshop Seated</p>
                                    </div>
                                    {shopStatus === 'closed' && <div className="mt-2 size-2 bg-red-500 rounded-full animate-ping"></div>}
                                </div>
                            </div>

                            <div className="bg-white dark:bg-gray-900 rounded-[2.5rem] p-8 border border-gray-100 dark:border-gray-800 shadow-sm relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-8 opacity-10">
                                    <span className="material-symbols-outlined text-[100px]">history</span>
                                </div>
                                <h3 className="text-sm font-black text-gray-400 uppercase tracking-[0.3em] mb-8 flex items-center gap-2">
                                    <span className="size-2 bg-primary rounded-full"></span>
                                    Terminal Log
                                </h3>
                                <div className="space-y-6">
                                    {history.map(item => (
                                        <div key={item.id} className="flex items-start gap-4 relative">
                                            <div className="mt-1 flex flex-col items-center gap-2">
                                                <div className={`size-3 rounded-full ${item.status === 'open' ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                                <div className="w-px h-10 bg-gray-100 dark:bg-gray-800"></div>
                                            </div>
                                            <div className="flex-1">
                                                <div className="flex justify-between items-start">
                                                    <p className="text-sm font-black dark:text-white">{item.action}</p>
                                                    <span className="text-[10px] font-bold text-gray-400 font-mono tracking-tighter">{item.time}</span>
                                                </div>
                                                <p className="text-[10px] text-gray-500 font-bold uppercase tracking-widest mt-1">{item.date || 'Jan 17, 2026'}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </main>
                </Layout>
            );
        };





        // --- Main App ---


        const HistoryScreen = () => {
            const navigate = useNavigate();
            const location = useLocation();
            const searchParams = new URLSearchParams(location.search);
            const customerFilter = searchParams.get('customer');

            const [history, setHistory] = useState([]);

            useEffect(() => {
                const allEstimates = Store.getEstimates();
                if (customerFilter) {
                    setHistory(allEstimates.filter(e => e.customer === customerFilter));
                } else {
                    setHistory(allEstimates);
                }
            }, [customerFilter]);

            return (
                <Layout>
                    <main className="flex justify-center py-6 px-4 pb-28">
                        <div className="w-full max-w-[600px] flex flex-col gap-6">
                            <div className="flex flex-col gap-1">
                                <div className="flex items-center gap-2">
                                    {customerFilter && (
                                        <button onClick={() => navigate(-1)} className="material-symbols-outlined text-gray-500 hover:text-black dark:hover:text-white">arrow_back</button>
                                    )}
                                    <h2 className="text-2xl font-bold tracking-tight">{customerFilter ? `History: ${customerFilter}` : 'Service History'}</h2>
                                </div>
                                <p className="text-[#617589] text-sm">{customerFilter ? `Past jobs for ${customerFilter}` : 'Past estimates and invoices.'}</p>
                            </div>

                            {history.length === 0 ? (
                                <div className="text-center py-10 bg-white dark:bg-gray-900 rounded-xl border border-dashed border-gray-300 dark:border-gray-700">
                                    <p className="text-gray-500">No history found.</p>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-4">
                                    {history.map(est => (
                                        <div key={est.id}
                                            onClick={() => navigate(`/invoice/${est.id}`)}
                                            className="cursor-pointer bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-[#f0f2f4] dark:border-gray-800 overflow-hidden flex transition-all hover:bg-gray-50 dark:hover:bg-gray-800">
                                            <div className="w-24 overflow-hidden bg-gray-100 dark:bg-gray-800 shrink-0">
                                                <img
                                                    src={est.img || 'assets/services/general repair.png'}
                                                    className="w-full h-full object-cover"
                                                    onError={(e) => { e.target.src = 'assets/services/general repair.png'; }}
                                                />
                                            </div>
                                            <div className="flex-1 p-3 flex flex-col justify-center gap-1">
                                                <div className="flex justify-between items-center">
                                                    <h3 className="font-bold text-[#111418] dark:text-white text-sm">{est.customer}</h3>
                                                    <span className="text-xs text-gray-500">{est.date}</span>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <p className="text-xs text-gray-500">{est.vehicle}</p>
                                                    <StatusBadge status={est.status} />
                                                </div>
                                                <div className="mt-1">
                                                    <span className="text-sm font-bold text-primary">{Store.getSettings().currencySymbol}{Number(est.amount).toFixed(2)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </main>
                </Layout>
            );
        };

        const CustomersScreen = () => {
            const navigate = useNavigate();
            const [customers, setCustomers] = useState([]);

            const refreshCustomers = React.useCallback(() => {
                const estimates = Store.getEstimates();
                const users = Store.getUsers();
                const uniqueCustomers = [];
                const map = new Map();
                for (const item of estimates) {
                    if (!map.has(item.customer)) {
                        // Attempt to resolve the real user to get their Key and Avatar
                        const linkedUser = users.find(u =>
                            (item.customerKey && u.shareKey === item.customerKey) ||
                            (item.phone && Store.normalizePhone(u.phone) === Store.normalizePhone(item.phone)) ||
                            u.name === item.customer
                        );

                        const customerWithKey = Object.assign({}, item, {
                            shareKey: linkedUser ? linkedUser.shareKey : (item.customerKey || null),
                            avatar: linkedUser ? linkedUser.avatar : null,
                            email: linkedUser ? linkedUser.email : null
                        });

                        map.set(item.customer, customerWithKey);
                        uniqueCustomers.push(customerWithKey);
                    }
                }
                setCustomers(uniqueCustomers);
            }, []);

            useEffect(() => {
                refreshCustomers();
            }, [refreshCustomers]);

            const handleDelete = (name) => {
                if (window.confirm(`Are you sure you want to archive customer "${name}" and all their history? This will mark all requests as archived.`)) {
                    Store.deleteCustomer(name);
                    refreshCustomers();
                }
            };

            return (
                <Layout>
                    <main className="flex justify-center py-6 px-4 pb-28">
                        <div className="w-full max-w-[600px] flex flex-col gap-6">
                            <div className="flex flex-col gap-1">
                                <h2 className="text-2xl font-bold tracking-tight">My Customers</h2>
                                <p className="text-[#617589] text-sm">Contact list and unique access keys.</p>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {customers.length === 0 ? (
                                    <div className="col-span-2 text-center text-gray-500 py-10">No customers found.</div>
                                ) : (
                                    customers.map((cust, idx) => (
                                        <div key={idx} className="bg-white dark:bg-gray-900 rounded-xl p-4 border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col items-center text-center gap-3 hover:shadow-md transition-shadow relative overflow-hidden">
                                            {cust.shareKey && (
                                                <div className="absolute top-0 right-0 p-2">
                                                    <span className="bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 text-[10px] font-bold px-2 py-0.5 rounded-full font-mono">
                                                        {cust.shareKey}
                                                    </span>
                                                </div>
                                            )}

                                            <div className="size-20 rounded-full border-4 border-blue-50 dark:border-blue-900 shadow-xl overflow-hidden mt-2 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-gray-800 dark:to-gray-900">
                                                <img
                                                    src={cust.avatar || 'assets/emojis/male/005.png'}
                                                    alt={cust.customer}
                                                    className="w-full h-full object-cover scale-[1.6] relative top-2"
                                                />
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-lg leading-tight">{cust.customer}</h3>
                                                <p className="text-sm text-gray-500">{cust.phone}</p>
                                                {cust.email && <p className="text-xs text-blue-500 font-medium mt-1">{cust.email}</p>}
                                            </div>

                                            {cust.shareKey && (
                                                <div className="flex items-center gap-1 bg-gray-50 dark:bg-gray-800/50 px-3 py-1.5 rounded-lg border border-gray-100 dark:border-gray-700 w-full justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                                    onClick={() => { navigator.clipboard.writeText(cust.shareKey); alert('Key copied: ' + cust.shareKey); }}>
                                                    <span className="material-symbols-outlined text-gray-400 text-xs">key</span>
                                                    <span className="text-xs font-mono font-bold text-gray-700 dark:text-gray-300">Key: {cust.shareKey}</span>
                                                </div>
                                            )}

                                            <div className="w-full pt-1">
                                                <div className="flex items-center justify-center gap-2 text-xs text-gray-400 pb-2">
                                                    <span className="material-symbols-outlined text-sm">directions_car</span>
                                                    {cust.vehicle}
                                                </div>
                                            </div>

                                            <div className="flex flex-col w-full gap-2 mt-auto">
                                                <button
                                                    onClick={() => navigate(`/history?customer=${encodeURIComponent(cust.customer)}`)}
                                                    className="w-full py-2 text-primary text-sm font-bold hover:bg-primary/5 rounded-lg transition-colors cursor-pointer border border-primary/10">
                                                    View History
                                                </button>
                                                <button
                                                    onClick={() => handleDelete(cust.customer)}
                                                    className="w-full py-2 text-red-500 text-sm font-bold hover:bg-red-50 dark:hover:bg-red-900/10 rounded-lg transition-colors cursor-pointer">
                                                    Archive
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </main>
                </Layout>
            );
        };

        const NotificationsScreen = () => {
            const [notifications, setNotifications] = useState([]);
            const [filter, setFilter] = useState('all');
            const navigate = useNavigate();

            useEffect(() => {
                const load = () => {
                    const all = Store.getNotifications('mechanic');
                    setNotifications(all);
                };
                load();
                const unsubscribe = Store.subscribe((e) => {
                    if (e.type === 'NOTIFICATION_ADDED' || e.type === 'NOTIFICATION_UPDATED' || e.type === 'STORAGE_UPDATED') {
                        load();
                    }
                });
                return () => unsubscribe();
            }, []);

            const filtered = notifications.filter(n => {
                if (filter === 'unread') return !n.read;
                return true;
            });

            return (
                <Layout>
                    <div className="max-w-4xl mx-auto animate-fade-in">
                        <div className="flex items-center justify-between mb-8">
                            <div>
                                <h1 className="text-3xl font-black text-[#111418] dark:text-white tracking-tight">Notification Center</h1>
                                <p className="text-gray-500 mt-2 font-medium">Manage your alerts and updates.</p>
                            </div>
                            <div className="flex bg-white dark:bg-gray-800 p-1 rounded-xl border border-gray-200 dark:border-gray-700">
                                <button
                                    onClick={() => setFilter('all')}
                                    className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${filter === 'all' ? 'bg-gray-100 dark:bg-gray-700 text-primary' : 'text-gray-400 hover:text-gray-600'}`}
                                >
                                    All
                                </button>
                                <button
                                    onClick={() => setFilter('unread')}
                                    className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${filter === 'unread' ? 'bg-gray-100 dark:bg-gray-700 text-primary' : 'text-gray-400 hover:text-gray-600'}`}
                                >
                                    Unread
                                </button>
                            </div>
                        </div>

                        <div className="flex flex-col gap-4">
                            {filtered.length === 0 ? (
                                <div className="text-center py-20 bg-white dark:bg-gray-900 rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm">
                                    <div className="size-20 bg-gray-50 dark:bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <span className="material-symbols-outlined text-4xl text-gray-300">notifications_off</span>
                                    </div>
                                    <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-2">All caught up!</h3>
                                    <p className="text-gray-500 max-w-xs mx-auto">You have no matching notifications at the moment.</p>
                                </div>
                            ) : (
                                filtered.map(notification => (
                                    <div
                                        key={notification.id}
                                        className={`bg-white dark:bg-gray-900 p-6 rounded-2xl border transition-all hover:scale-[1.01] hover:shadow-lg flex gap-5 ${notification.read ? 'border-gray-100 dark:border-gray-800 opacity-60' : 'border-blue-100 shadow-md ring-1 ring-blue-500/10'}`}
                                        onClick={() => Store.markNotificationAsRead(notification.id)}
                                    >
                                        <div className={`size-12 rounded-full flex items-center justify-center shrink-0 ${notification.read ? 'bg-gray-100 dark:bg-gray-800 text-gray-400' : 'bg-blue-600 text-white shadow-lg shadow-blue-500/30'}`}>
                                            <span className="material-symbols-outlined text-xl">
                                                {notification.type === 'new_request' ? 'assignment_add' : 'notifications'}
                                            </span>
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex justify-between items-start mb-1">
                                                <h3 className={`text-base font-bold truncate pr-4 ${notification.read ? 'text-gray-700 dark:text-gray-300' : 'text-[#111418] dark:text-white'}`}>
                                                    {notification.title}
                                                </h3>
                                                <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest whitespace-nowrap">{notification.time}</span>
                                            </div>
                                            <p className="text-sm text-gray-500 leading-relaxed mb-3">{notification.message}</p>

                                            {notification.data && notification.data.id && (
                                                <button
                                                    className="inline-flex items-center gap-2 text-xs font-black text-primary uppercase tracking-widest hover:underline bg-transparent border-none p-0 cursor-pointer"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        Store.markNotificationAsRead(notification.id);
                                                        navigate(`/review/${notification.data.id}`);
                                                    }}
                                                >
                                                    View Details <span className="material-symbols-outlined text-sm">arrow_forward</span>
                                                </button>
                                            )}
                                        </div>
                                        {!notification.read && (
                                            <div className="shrink-0 self-center">
                                                <div className="size-2 rounded-full bg-blue-500 ring-4 ring-blue-100 dark:ring-blue-900/30"></div>
                                            </div>
                                        )}
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </Layout>
            );
        };

        const ProfileScreen = () => {
            const navigate = useNavigate();
            const [user, setUser] = useState(Store.getCurrentUser());
            const [stats, setStats] = useState(Store.getStats());
            const [editing, setEditing] = useState(false);
            const [newPassword, setNewPassword] = useState('');
            const [showEmojiPicker, setShowEmojiPicker] = useState(false);

            useEffect(() => {
                const unsubscribe = Store.subscribe(() => {
                    setUser(Store.getCurrentUser());
                    setStats(Store.getStats());
                });
                return () => unsubscribe();
            }, []);

            const handleUpdateProfile = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const updatedUser = Object.assign({}, user, {
                    name: formData.get('name'),
                    email: formData.get('email')
                });
                if (newPassword) updatedUser.password = newPassword;

                Store.saveUser(updatedUser);
                localStorage.setItem('mechflow_user', JSON.stringify(updatedUser));
                setEditing(false);
                alert('Profile Updated Successfully!');
            };

            const handleAvatarUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const updatedUser = Object.assign({}, user, { avatar: reader.result });
                        Store.saveUser(updatedUser);
                        localStorage.setItem('mechflow_user', JSON.stringify(updatedUser));
                        setUser(updatedUser);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const pickEmoji = (emoji) => {
                const updatedUser = Object.assign({}, user, { avatar: `assets/emojis/male/${emoji}` });
                Store.saveUser(updatedUser);
                localStorage.setItem('mechflow_user', JSON.stringify(updatedUser));
                setUser(updatedUser);
                setShowEmojiPicker(false);
            };

            return (
                <Layout>
                    <main className="flex justify-center py-10 px-4 pb-28">
                        <div className="w-full max-w-[500px] flex flex-col gap-6 animate-fade-in">
                            <div className="bg-white dark:bg-gray-900 rounded-[2.5rem] p-8 border border-gray-100 dark:border-gray-800 shadow-xl flex flex-col items-center relative overflow-hidden">
                                <div className="absolute top-0 inset-x-0 h-32 bg-primary/5"></div>

                                <div className="relative mb-6 z-10">
                                    <div className="size-32 rounded-[2rem] border-4 border-white dark:border-gray-800 overflow-hidden shadow-2xl bg-gradient-to-br from-blue-50 to-blue-100 dark:from-gray-800 dark:to-gray-900 transform -rotate-3 hover:rotate-0 transition-transform">
                                        <img src={user?.avatar || 'assets/emojis/male/008.png'} alt="Avatar" className="w-full h-full object-cover scale-[1.8] relative top-4" />
                                    </div>
                                    <div className="absolute -bottom-2 -right-2 flex gap-1">
                                        <button onClick={() => setShowEmojiPicker(!showEmojiPicker)} className="bg-white dark:bg-gray-800 text-primary rounded-xl p-2 shadow-lg border border-gray-100 dark:border-gray-700 hover:scale-110 transition-all">
                                            <span className="material-symbols-outlined text-sm">mood</span>
                                        </button>
                                        <label className="bg-primary text-white rounded-xl p-2 shadow-lg hover:scale-110 transition-all cursor-pointer">
                                            <span className="material-symbols-outlined text-sm">upload</span>
                                            <input type="file" className="hidden" accept="image/*" onChange={handleAvatarUpload} />
                                        </label>
                                    </div>
                                </div>

                                {showEmojiPicker && (
                                    <div className="absolute top-48 z-50 bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-700 grid grid-cols-5 gap-2 animate-zoom-in">
                                        {['001.png', '002.png', '003.png', '004.png', '005.png', '006.png', '007.png', '008.png', '009.png', '010.png'].map(emoji => (
                                            <img key={emoji} src={`assets/emojis/male/${emoji}`} className="size-10 cursor-pointer hover:bg-primary/10 rounded-lg p-1" onClick={() => pickEmoji(emoji)} />
                                        ))}
                                    </div>
                                )}

                                <div className="text-center z-10">
                                    <h1 className="text-3xl font-black dark:text-white uppercase tracking-tight mb-1">{user?.name || 'Mechanic'}</h1>
                                    <div className="inline-flex items-center gap-2 bg-blue-500/10 text-blue-600 dark:text-blue-400 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">
                                        <span className="material-symbols-outlined text-xs">verified</span> Certified Specialist
                                    </div>
                                </div>

                                <div className="flex gap-8 w-full mt-10 border-t border-gray-100 dark:border-gray-800 pt-8 z-10">
                                    <div className="flex-1 text-center">
                                        <span className="block text-3xl font-black text-primary">{stats?.jobsDone || 0}</span>
                                        <span className="text-[10px] text-gray-400 font-black uppercase tracking-widest mt-1">Jobs Done</span>
                                    </div>
                                    <div className="flex-1 text-center border-l border-gray-100 dark:border-gray-800">
                                        <div className="flex items-center justify-center gap-1">
                                            <span className="block text-3xl font-black text-primary">{stats?.rating || 0}</span>
                                            <span className="material-symbols-outlined text-amber-400 text-sm">star</span>
                                        </div>
                                        <span className="text-[10px] text-gray-400 font-black uppercase tracking-widest mt-1">Real-time Rating</span>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white dark:bg-gray-900 rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-xl overflow-hidden">
                                <div className="p-6 border-b border-gray-50 dark:border-gray-800 flex justify-between items-center bg-gray-50/50 dark:bg-gray-800/20">
                                    <span className="text-xs font-black uppercase tracking-[0.2em] text-gray-400">Security & Credentials</span>
                                    <button onClick={() => setEditing(!editing)} className="text-primary text-xs font-black uppercase tracking-widest hover:underline">
                                        {editing ? 'Cancel' : 'Edit Profile'}
                                    </button>
                                </div>
                                <form onSubmit={handleUpdateProfile} className="p-8 flex flex-col gap-6">
                                    <div className="flex flex-col gap-2">
                                        <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Display Name</label>
                                        <input name="name" className={`form-input rounded-xl dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-12 px-4 font-bold transition-all ${!editing && 'bg-gray-50/50 pointer-events-none'}`} defaultValue={user?.name || ''} type="text" required />
                                    </div>
                                    <div className="flex flex-col gap-2">
                                        <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Terminal Email</label>
                                        <input name="email" className={`form-input rounded-xl dark:bg-gray-800 border-gray-300 dark:border-gray-700 h-12 px-4 font-bold transition-all ${!editing && 'bg-gray-50/50 pointer-events-none'}`} defaultValue={user?.email || ''} type="email" required />
                                    </div>

                                    {editing && (
                                        <div className="flex flex-col gap-2 animate-slide-up">
                                            <label className="text-[10px] font-black text-primary uppercase tracking-widest">New Session Password</label>
                                            <input className="form-input rounded-xl dark:bg-gray-800 border-primary/30 dark:border-primary/20 h-12 px-4 font-bold focus:ring-primary/20" placeholder="" type="password" onChange={(e) => setNewPassword(e.target.value)} />
                                            <p className="text-[9px] text-gray-500 font-medium">Leave blank to keep existing password</p>
                                        </div>
                                    )}

                                    {editing && (
                                        <button className="w-full bg-primary text-white font-black py-4 rounded-2xl shadow-xl shadow-primary/20 hover:scale-[1.02] active:scale-95 transition-all mt-4" type="submit">
                                            Save Profile Changes
                                        </button>
                                    )}
                                </form>
                            </div>
                        </div>
                    </main>
                </Layout>
            );
        };

        const App = () => {
            return (
                <MemoryRouter>
                    <Routes>
                        <Route path="/" element={<LoginScreen />} />
                        <Route path="/dashboard" element={<DashboardScreen />} />
                        <Route path="/create-estimate" element={<CreateEstimateScreen />} />
                        <Route path="/review/:id" element={<ReviewScreen />} />
                        <Route path="/processing/:id" element={<ProcessingScreen />} />
                        <Route path="/invoice/:id" element={<InvoiceScreen />} />
                        <Route path="/success" element={<SuccessScreen />} />
                        <Route path="/settings" element={<SettingsScreen />} />
                        <Route path="/offline-error" element={<OfflineErrorScreen />} />
                        <Route path="/login" element={<LoginScreen />} />

                        <Route path="/history" element={<HistoryScreen />} />
                        <Route path="/customers" element={<CustomersScreen />} />
                        <Route path="/profile" element={<ProfileScreen />} />
                        <Route path="/notifications" element={<NotificationsScreen />} />
                        <Route path="/time-tracking" element={<TimeTrackingScreen />} />
                        {/* Route path="/status/:id" element={<CustomerStatusScreen />} / */}
                    </Routes>
                </MemoryRouter>
            );
        };

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>

</html>